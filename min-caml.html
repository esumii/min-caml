<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=euc-jp">
  <title>
MinCaml Source Code</title>
  <meta name="GENERATOR" content="caml2html 1.4.1">
<style type="text/css">
code,pre { color:black;background-color:white }a.Cannot { color:black;text-decoration:none }.Cannot:hover { background-color: #b4eeb4; }
.Cbar,
.Cdo,
.Cdone,
.Cdownto,
.Celse,
.Cfor,
.Cif,
.Clazy,
.Cmatch,
.Cnew,
.Cor,
.Cthen,
.Cto,
.Ctry,
.Cwhen,
.Cwhile,
.Cwith { color: #77aaaa; }
.Cassert,
.Cinclude,
.Copen { color: #cc9900; }
.Cstring { color: #aa4444; }
.Cand,
.Cas,
.Cclass,
.Cconstraint,
.Cexception,
.Cexternal,
.Cfun,
.Cfunction,
.Cfunctor,
.Cin,
.Cinherit,
.Cinitializer,
.Clet,
.Cmethod,
.Cmodule,
.Cmutable,
.Cof,
.Cprivate,
.Crec,
.Ctype,
.Cval,
.Cvirtual { color: green; }
.Cbackground { background-color: white; }
.Craise { color: red; }
.Cconstructor { color: #0033cc; }
.Ccomment { color: #990000; }
.Calphakeyword,
.Casr,
.Cland,
.Clor,
.Clsl,
.Clsr,
.Clxor,
.Cmod { color: #808080; }
.Clinenum { color: black; background-color: silver; }
.Cbegin,
.Cend,
.Cobject,
.Csig,
.Cstruct { color: #990099; }
.Cfalse,
.Cnonalphakeyword,
.Cquotation,
.Ctrue { }
</style>
</head>
<body>
<h1><a name="main.mli"></a><code>main.mli</code></h1>

<pre><span class="Cval">val</span> limit : int ref
<span class="Cval">val</span> string : string <span class="Cnonalphakeyword">-&gt;</span> unit
<span class="Cval">val</span> file : string <span class="Cnonalphakeyword">-&gt;</span> unit
</pre>

<hr>
<h1><a name="main.ml"></a><code>main.ml</code></h1>
<a name="main_iter"></a>
<pre><span class="Clet">let</span> limit <span class="Cnonalphakeyword">=</span> ref 1000

<span class="Clet">let</span> <span class="Crec">rec</span> iter n e <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ºÇÅ¬²½½èÍý¤ò¤¯¤ê¤«¤¨¤¹ *)</span>
  <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"iteration %d@."</span> n<span class="Cnonalphakeyword">;</span>
  <span class="Cif">if</span> n <span class="Cnonalphakeyword">=</span> 0 <span class="Cthen">then</span> e <span class="Celse">else</span>
  <span class="Clet">let</span> e' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Elim</span><span class="Cnonalphakeyword">.</span>f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">ConstFold</span><span class="Cnonalphakeyword">.</span>f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Inline</span><span class="Cnonalphakeyword">.</span>f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Assoc</span><span class="Cnonalphakeyword">.</span>f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Beta</span><span class="Cnonalphakeyword">.</span>f e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
<a name="main_lexbuf"></a>  <span class="Cif">if</span> e <span class="Cnonalphakeyword">=</span> e' <span class="Cthen">then</span> e <span class="Celse">else</span>
  iter <span class="Cnonalphakeyword">(</span>n <span class="Cnonalphakeyword">-</span> 1<span class="Cnonalphakeyword">)</span> e'

<span class="Clet">let</span> lexbuf outchan l <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥Ð¥Ã¥Õ¥¡¤ò¥³¥ó¥Ñ¥¤¥ë¤·¤Æ¥Á¥ã¥ó¥Í¥ë¤Ø½ÐÎÏ¤¹¤ë *)</span>
  <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>counter <span class="Cnonalphakeyword">:=</span> 0<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Typing</span><span class="Cnonalphakeyword">.</span>extenv <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Emit</span><span class="Cnonalphakeyword">.</span>f outchan
    <span class="Cnonalphakeyword">(</span><span class="Cconstructor">RegAlloc</span><span class="Cnonalphakeyword">.</span>f
       <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Simm</span><span class="Cnonalphakeyword">.</span>f
          <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Virtual</span><span class="Cnonalphakeyword">.</span>f
             <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>f
                <span class="Cnonalphakeyword">(</span>iter !limit
                   <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Alpha</span><span class="Cnonalphakeyword">.</span>f
                      <span class="Cnonalphakeyword">(</span><span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>f
<a name="main_string"></a>                         <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Typing</span><span class="Cnonalphakeyword">.</span>f
                            <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Parser</span><span class="Cnonalphakeyword">.</span>exp <span class="Cconstructor">Lexer</span><span class="Cnonalphakeyword">.</span>token l<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="main_file"></a>
<span class="Clet">let</span> string s <span class="Cnonalphakeyword">=</span> lexbuf stdout <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>from_string s<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* Ê¸»úÎó¤ò¥³¥ó¥Ñ¥¤¥ë¤·¤ÆÉ¸½à½ÐÎÏ¤ËÉ½¼¨¤¹¤ë *)</span>

<span class="Clet">let</span> file f <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥Õ¥¡¥¤¥ë¤ò¥³¥ó¥Ñ¥¤¥ë¤·¤Æ¥Õ¥¡¥¤¥ë¤Ë½ÐÎÏ¤¹¤ë *)</span>
  <span class="Clet">let</span> inchan <span class="Cnonalphakeyword">=</span> open_in <span class="Cnonalphakeyword">(</span>f ^ <span class="Cstring">".ml"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Clet">let</span> outchan <span class="Cnonalphakeyword">=</span> open_out <span class="Cnonalphakeyword">(</span>f ^ <span class="Cstring">".s"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Ctry">try</span>
    lexbuf outchan <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>from_channel inchan<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
    close_in inchan<span class="Cnonalphakeyword">;</span>
<a name="main_entry"></a>    close_out outchan<span class="Cnonalphakeyword">;</span>
  <span class="Cwith">with</span> e <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>close_in inchan<span class="Cnonalphakeyword">;</span> close_out outchan<span class="Cnonalphakeyword">;</span> raise e<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¤³¤³¤«¤é¥³¥ó¥Ñ¥¤¥é¤Î¼Â¹Ô¤¬³«»Ï¤µ¤ì¤ë *)</span>
  <span class="Clet">let</span> files <span class="Cnonalphakeyword">=</span> ref <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cin">in</span>
  <span class="Cconstructor">Arg</span><span class="Cnonalphakeyword">.</span>parse
    <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"-inline"</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Arg</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> i <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Inline</span><span class="Cnonalphakeyword">.</span>threshold <span class="Cnonalphakeyword">:=</span> i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cstring">"maximum size of functions inlined"</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
     <span class="Cnonalphakeyword">(</span><span class="Cstring">"-iter"</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Arg</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> i <span class="Cnonalphakeyword">-&gt;</span> limit <span class="Cnonalphakeyword">:=</span> i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cstring">"maximum number of optimizations iterated"</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">]</span>
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> s <span class="Cnonalphakeyword">-&gt;</span> files <span class="Cnonalphakeyword">:=</span> !files @ <span class="Cnonalphakeyword">[</span>s<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
    <span class="Cnonalphakeyword">(</span><span class="Cstring">"Mitou Min-Caml Compiler (C) Eijiro Sumii\n"</span> ^
     <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"usage: %s [-inline m] [-iter n] ...filenames without \".ml\"..."</span> <span class="Cconstructor">Sys</span><span class="Cnonalphakeyword">.</span>argv<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> f <span class="Cnonalphakeyword">-&gt;</span> ignore <span class="Cnonalphakeyword">(</span>file f<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    !files
</pre>

<a name="id_t"></a><hr>
<a name="id_l"></a><h1><a name="id.ml"></a><code>id.ml</code></h1>

<pre><span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> string <span class="Ccomment">(* ÊÑ¿ô¤ÎÌ¾Á° *)</span>
<span class="Ctype">type</span> l <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">L</span> <span class="Cof">of</span> string <span class="Ccomment">(* ¥È¥Ã¥×¥ì¥Ù¥ë´Ø¿ô¤ä¥°¥í¡¼¥Ð¥ëÇÛÎó¤Î¥é¥Ù¥ë *)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> pp_list <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">""</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> x
  <span class="Cbar">|</span> x <span class="Cnonalphakeyword">::</span> xs <span class="Cnonalphakeyword">-&gt;</span> x ^ <span class="Cstring">" "</span> ^ pp_list xs

<span class="Clet">let</span> counter <span class="Cnonalphakeyword">=</span> ref 0
<span class="Clet">let</span> genid s <span class="Cnonalphakeyword">=</span>
  incr counter<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"%s.%d"</span> s !counter

<span class="Clet">let</span> <span class="Crec">rec</span> id_of_typ <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"u"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"b"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"i"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"d"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"f"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"t"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"a"</span> 
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span>
<span class="Clet">let</span> gentmp typ <span class="Cnonalphakeyword">=</span>
  incr counter<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"T%s%d"</span> <span class="Cnonalphakeyword">(</span>id_of_typ typ<span class="Cnonalphakeyword">)</span> !counter
</pre>

<hr>
<h1><a name="m.ml"></a><code>m.ml</code></h1>

<pre><span class="Ccomment">(* customized version of Map *)</span>

<span class="Cmodule">module</span> <span class="Cconstructor">M</span> <span class="Cnonalphakeyword">=</span>
  <span class="Cconstructor">Map</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Make</span>
    <span class="Cnonalphakeyword">(</span><span class="Cstruct">struct</span>
      <span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
      <span class="Clet">let</span> compare <span class="Cnonalphakeyword">=</span> compare
    <span class="Cend">end</span><span class="Cnonalphakeyword">)</span>
<span class="Cinclude">include</span> <span class="Cconstructor">M</span>

<span class="Clet">let</span> add_list xys env <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> env <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> add x y env<span class="Cnonalphakeyword">)</span> env xys
<span class="Clet">let</span> add_list2 xs ys env <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left2 <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> env x y <span class="Cnonalphakeyword">-&gt;</span> add x y env<span class="Cnonalphakeyword">)</span> env xs ys
</pre>

<hr>
<h1><a name="s.ml"></a><code>s.ml</code></h1>

<pre><span class="Ccomment">(* customized version of Set *)</span>

<span class="Cmodule">module</span> <span class="Cconstructor">S</span> <span class="Cnonalphakeyword">=</span>
  <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Make</span>
    <span class="Cnonalphakeyword">(</span><span class="Cstruct">struct</span>
      <span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
      <span class="Clet">let</span> compare <span class="Cnonalphakeyword">=</span> compare
    <span class="Cend">end</span><span class="Cnonalphakeyword">)</span>
<span class="Cinclude">include</span> <span class="Cconstructor">S</span>

<span class="Clet">let</span> of_list l <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> s e <span class="Cnonalphakeyword">-&gt;</span> add e s<span class="Cnonalphakeyword">)</span> empty l
</pre>

<a name="syntax_t"></a><hr>
<h1><a name="syntax.ml"></a><code>syntax.ml</code></h1>

<pre><span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* MinCaml¤Î¹½Ê¸¤òÉ½¸½¤¹¤ë¥Ç¡¼¥¿·¿ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Bool</span> <span class="Cof">of</span> bool
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span> <span class="Cof">of</span> float
  <span class="Cbar">|</span> <span class="Cconstructor">Not</span> <span class="Cof">of</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span> <span class="Cof">of</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Eq</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">LE</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">If</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span> <span class="Cof">of</span> fundef <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t list
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> t list
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Array</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
<span class="Cand">and</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">;</span> args : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span> body : t <span class="Cnonalphakeyword">}</span>
</pre>

<a name="type_t"></a><hr>
<h1><a name="type.ml"></a><code>type.ml</code></h1>

<pre><span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* MinCaml¤Î·¿¤òÉ½¸½¤¹¤ë¥Ç¡¼¥¿·¿ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Bool</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Fun</span> <span class="Cof">of</span> t list <span class="Cnonalphakeyword">*</span> t <span class="Ccomment">(* arguments are uncurried *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> t list
  <span class="Cbar">|</span> <span class="Cconstructor">Array</span> <span class="Cof">of</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> t option ref

<span class="Clet">let</span> gentyp <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>ref <span class="Cconstructor">None</span><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* ¿·¤·¤¤·¿ÊÑ¿ô¤òºî¤ë *)</span>
</pre>

<hr>
<h1><a name="parser.mly"></a><code>parser.mly</code></h1>

<pre>%<span class="Cnonalphakeyword">{</span>
<span class="Ccomment">(* parser¤¬ÍøÍÑ¤¹¤ëÊÑ¿ô¡¢´Ø¿ô¡¢·¿¤Ê¤É¤ÎÄêµÁ *)</span>
<span class="Copen">open</span> <span class="Cconstructor">Syntax</span>
<span class="Clet">let</span> addtyp x <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>gentyp <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
%<span class="Cnonalphakeyword">}</span>

/* »ú¶ç¤òÉ½¤¹¥<span class="Cconstructor">Ç</span>¡¼¥¿·¿¤<span class="Cconstructor">ÎÄê</span>µ<span class="Cconstructor">Á</span> <span class="Cnonalphakeyword">(</span>caml2html: parser_token<span class="Cnonalphakeyword">)</span> */
%token <span class="Cnonalphakeyword">&lt;</span>bool<span class="Cnonalphakeyword">&gt;</span> <span class="Cconstructor">BOOL</span>
%token <span class="Cnonalphakeyword">&lt;</span>int<span class="Cnonalphakeyword">&gt;</span> <span class="Cconstructor">INT</span>
%token <span class="Cnonalphakeyword">&lt;</span>float<span class="Cnonalphakeyword">&gt;</span> <span class="Cconstructor">FLOAT</span>
%token <span class="Cconstructor">NOT</span>
%token <span class="Cconstructor">MINUS</span>
%token <span class="Cconstructor">PLUS</span>
%token <span class="Cconstructor">MINUS_DOT</span>
%token <span class="Cconstructor">PLUS_DOT</span>
%token <span class="Cconstructor">AST_DOT</span>
%token <span class="Cconstructor">SLASH_DOT</span>
%token <span class="Cconstructor">EQUAL</span>
%token <span class="Cconstructor">LESS_GREATER</span>
%token <span class="Cconstructor">LESS_EQUAL</span>
%token <span class="Cconstructor">GREATER_EQUAL</span>
%token <span class="Cconstructor">LESS</span>
%token <span class="Cconstructor">GREATER</span>
%token <span class="Cconstructor">IF</span>
%token <span class="Cconstructor">THEN</span>
%token <span class="Cconstructor">ELSE</span>
%token <span class="Cnonalphakeyword">&lt;</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">&gt;</span> <span class="Cconstructor">IDENT</span>
%token <span class="Cconstructor">LET</span>
%token <span class="Cconstructor">IN</span>
%token <span class="Cconstructor">REC</span>
%token <span class="Cconstructor">COMMA</span>
%token <span class="Cconstructor">ARRAY_CREATE</span>
%token <span class="Cconstructor">DOT</span>
%token <span class="Cconstructor">LESS_MINUS</span>
%token <span class="Cconstructor">SEMICOLON</span>
%token <span class="Cconstructor">LPAREN</span>
%token <span class="Cconstructor">RPAREN</span>
%token <span class="Cconstructor">EOF</span>

/* <span class="Cconstructor">Í</span>¥<span class="Cconstructor">Àè</span>½ç°<span class="Cconstructor">Ì</span>¤<span class="Cconstructor">Èassociativity</span>¤<span class="Cconstructor">ÎÄê</span>µ<span class="Cconstructor">Á</span>¡<span class="Cconstructor">ÊÄã</span>¤¤<span class="Cconstructor">Êý</span>¤«¤é¹â¤¤<span class="Cconstructor">Êý</span>¤<span class="Cconstructor">Ø</span>¡<span class="Cconstructor">Ë</span> <span class="Cnonalphakeyword">(</span>caml2html: parser_prior<span class="Cnonalphakeyword">)</span> */
%right prec_let
%right <span class="Cconstructor">SEMICOLON</span>
%right prec_if
%right <span class="Cconstructor">LESS_MINUS</span>
%left <span class="Cconstructor">COMMA</span>
%left <span class="Cconstructor">EQUAL</span> <span class="Cconstructor">LESS_GREATER</span> <span class="Cconstructor">LESS</span> <span class="Cconstructor">GREATER</span> <span class="Cconstructor">LESS_EQUAL</span> <span class="Cconstructor">GREATER_EQUAL</span>
%left <span class="Cconstructor">PLUS</span> <span class="Cconstructor">MINUS</span> <span class="Cconstructor">PLUS_DOT</span> <span class="Cconstructor">MINUS_DOT</span>
%left <span class="Cconstructor">AST_DOT</span> <span class="Cconstructor">SLASH_DOT</span>
%right prec_unary_minus
%left prec_app
%left <span class="Cconstructor">DOT</span>

/* ³«»<span class="Cconstructor">Ï</span>µ­¹æ¤<span class="Cconstructor">ÎÄê</span>µ<span class="Cconstructor">Á</span> */
%<span class="Ctype">type</span> <span class="Cnonalphakeyword">&lt;</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">&gt;</span> exp
%start exp

%%

simple_exp: /* ³ç¸<span class="Cconstructor">Ì</span>¤ò¤<span class="Cconstructor">Ä</span>¤±¤<span class="Cconstructor">Ê</span>¤¯¤<span class="Cconstructor">Æ</span>¤â´<span class="Cconstructor">Ø</span>¿ô¤<span class="Cconstructor">Î</span>°ú¿ô¤<span class="Cconstructor">Ë</span>¤<span class="Cconstructor">Ê</span>¤ì¤ë¼° <span class="Cnonalphakeyword">(</span>caml2html: parser_simple<span class="Cnonalphakeyword">)</span> */
<span class="Cbar">|</span> <span class="Cconstructor">LPAREN</span> exp <span class="Cconstructor">RPAREN</span>
    <span class="Cnonalphakeyword">{</span> $2 <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">LPAREN</span> <span class="Cconstructor">RPAREN</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">BOOL</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">INT</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">FLOAT</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">IDENT</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> simple_exp <span class="Cconstructor">DOT</span> <span class="Cconstructor">LPAREN</span> exp <span class="Cconstructor">RPAREN</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $4<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>

exp: /* °ìÈÌ¤<span class="Cconstructor">Î</span>¼° <span class="Cnonalphakeyword">(</span>caml2html: parser_exp<span class="Cnonalphakeyword">)</span> */
<span class="Cbar">|</span> simple_exp
    <span class="Cnonalphakeyword">{</span> $1 <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">NOT</span> exp
    %prec prec_app
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>$2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">MINUS</span> exp
    %prec prec_unary_minus
    <span class="Cnonalphakeyword">{</span> <span class="Cmatch">match</span> $2 <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">-.</span>f<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* -1.23¤Ê¤É¤Ï·¿¥¨¥é¡¼¤Ç¤Ï¤Ê¤¤¤Î¤ÇÊÌ°·¤¤ *)</span>
    <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">PLUS</span> exp /* <span class="Cconstructor">Â</span>­¤·»»¤ò¹½<span class="Cconstructor">Ê</span>¸²òÀÏ¤¹¤ë¥ë¡¼¥ë <span class="Cnonalphakeyword">(</span>caml2html: parser_add<span class="Cnonalphakeyword">)</span> */
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">MINUS</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">EQUAL</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">LESS_GREATER</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">LESS</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>$3<span class="Cnonalphakeyword">,</span> $1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">GREATER</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">LESS_EQUAL</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">GREATER_EQUAL</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>$3<span class="Cnonalphakeyword">,</span> $1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">IF</span> exp <span class="Cconstructor">THEN</span> exp <span class="Cconstructor">ELSE</span> exp
    %prec prec_if
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>$2<span class="Cnonalphakeyword">,</span> $4<span class="Cnonalphakeyword">,</span> $6<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">MINUS_DOT</span> exp
    %prec prec_unary_minus
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>$2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">PLUS_DOT</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">MINUS_DOT</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">AST_DOT</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">SLASH_DOT</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">LET</span> <span class="Cconstructor">IDENT</span> <span class="Cconstructor">EQUAL</span> exp <span class="Cconstructor">IN</span> exp
    %prec prec_let
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>addtyp $2<span class="Cnonalphakeyword">,</span> $4<span class="Cnonalphakeyword">,</span> $6<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">LET</span> <span class="Cconstructor">REC</span> fundef <span class="Cconstructor">IN</span> exp
    %prec prec_let
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span>$3<span class="Cnonalphakeyword">,</span> $5<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp actual_args
    %prec prec_app
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> elems
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">LET</span> <span class="Cconstructor">LPAREN</span> pat <span class="Cconstructor">RPAREN</span> <span class="Cconstructor">EQUAL</span> exp <span class="Cconstructor">IN</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>$3<span class="Cnonalphakeyword">,</span> $6<span class="Cnonalphakeyword">,</span> $8<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> simple_exp <span class="Cconstructor">DOT</span> <span class="Cconstructor">LPAREN</span> exp <span class="Cconstructor">RPAREN</span> <span class="Cconstructor">LESS_MINUS</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>$1<span class="Cnonalphakeyword">,</span> $4<span class="Cnonalphakeyword">,</span> $7<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">SEMICOLON</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> $1<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">ARRAY_CREATE</span> simple_exp simple_exp
    %prec prec_app
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>$2<span class="Cnonalphakeyword">,</span> $3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> error
    <span class="Cnonalphakeyword">{</span> failwith
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"parse error near characters %d-%d"</span>
           <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Parsing</span><span class="Cnonalphakeyword">.</span>symbol_start <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
           <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Parsing</span><span class="Cnonalphakeyword">.</span>symbol_end <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>

fundef:
<span class="Cbar">|</span> <span class="Cconstructor">IDENT</span> formal_args <span class="Cconstructor">EQUAL</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> addtyp $1<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> $2<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> $4 <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">}</span>

formal_args:
<span class="Cbar">|</span> <span class="Cconstructor">IDENT</span> formal_args
    <span class="Cnonalphakeyword">{</span> addtyp $1 <span class="Cnonalphakeyword">::</span> $2 <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">IDENT</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">[</span>addtyp $1<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>

actual_args:
<span class="Cbar">|</span> actual_args simple_exp
    %prec prec_app
    <span class="Cnonalphakeyword">{</span> $1 @ <span class="Cnonalphakeyword">[</span>$2<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> simple_exp
    %prec prec_app
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">[</span>$1<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>

elems:
<span class="Cbar">|</span> elems <span class="Cconstructor">COMMA</span> exp
    <span class="Cnonalphakeyword">{</span> $1 @ <span class="Cnonalphakeyword">[</span>$3<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> exp <span class="Cconstructor">COMMA</span> exp
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">[</span>$1<span class="Cnonalphakeyword">;</span> $3<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>

pat:
<span class="Cbar">|</span> pat <span class="Cconstructor">COMMA</span> <span class="Cconstructor">IDENT</span>
    <span class="Cnonalphakeyword">{</span> $1 @ <span class="Cnonalphakeyword">[</span>addtyp $3<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cconstructor">IDENT</span> <span class="Cconstructor">COMMA</span> <span class="Cconstructor">IDENT</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">[</span>addtyp $1<span class="Cnonalphakeyword">;</span> addtyp $3<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">}</span>
</pre>

<hr>
<h1><a name="lexer.mll"></a><code>lexer.mll</code></h1>

<pre><span class="Cnonalphakeyword">{</span>
<span class="Ccomment">(* lexer¤¬ÍøÍÑ¤¹¤ëÊÑ¿ô¡¢´Ø¿ô¡¢·¿¤Ê¤É¤ÎÄêµÁ *)</span>
<span class="Copen">open</span> <span class="Cconstructor">Parser</span>
<span class="Copen">open</span> <span class="Cconstructor">Type</span>
<span class="Cnonalphakeyword">}</span>

<span class="Ccomment">(* Àµµ¬É½¸½¤ÎÎ¬µ­ *)</span>
<span class="Clet">let</span> space <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">' '</span> <span class="Cstring">'\t'</span> <span class="Cstring">'\n'</span> <span class="Cstring">'\r'</span><span class="Cnonalphakeyword">]</span>
<span class="Clet">let</span> digit <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">'0'</span><span class="Cnonalphakeyword">-</span><span class="Cstring">'9'</span><span class="Cnonalphakeyword">]</span>
<span class="Clet">let</span> lower <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">'a'</span><span class="Cnonalphakeyword">-</span><span class="Cstring">'z'</span><span class="Cnonalphakeyword">]</span>
<span class="Clet">let</span> upper <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">'A'</span><span class="Cnonalphakeyword">-</span><span class="Cstring">'Z'</span><span class="Cnonalphakeyword">]</span>

rule token <span class="Cnonalphakeyword">=</span> parse
<span class="Cbar">|</span> space<span class="Cnonalphakeyword">+</span>
    <span class="Cnonalphakeyword">{</span> token lexbuf <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"(*"</span>
    <span class="Cnonalphakeyword">{</span> comment lexbuf<span class="Cnonalphakeyword">;</span> <span class="Ccomment">(* ¥Í¥¹¥È¤·¤¿¥³¥á¥ó¥È¤Î¤¿¤á¤Î¥È¥ê¥Ã¥¯ *)</span>
      token lexbuf <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'('</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LPAREN</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">')'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">RPAREN</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"true"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">BOOL</span><span class="Cnonalphakeyword">(</span><span class="Ctrue">true</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"false"</span>
<a name="lexer_int"></a>    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">BOOL</span><span class="Cnonalphakeyword">(</span><span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"not"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">NOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> digit<span class="Cnonalphakeyword">+</span> <span class="Ccomment">(* À°¿ô¤ò»ú¶ç²òÀÏ¤¹¤ë¥ë¡¼¥ë *)</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">INT</span><span class="Cnonalphakeyword">(</span>int_of_string <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme lexbuf<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> digit<span class="Cnonalphakeyword">+</span> <span class="Cnonalphakeyword">(</span><span class="Cstring">'.'</span> digit<span class="Cnonalphakeyword">*</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">?</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">[</span><span class="Cstring">'e'</span> <span class="Cstring">'E'</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">'+'</span> <span class="Cstring">'-'</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">?</span> digit<span class="Cnonalphakeyword">+</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">?</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">FLOAT</span><span class="Cnonalphakeyword">(</span>float_of_string <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme lexbuf<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'-'</span> <span class="Ccomment">(* -.¤è¤ê¸å²ó¤·¤Ë¤·¤Ê¤¯¤Æ¤âÎÉ¤¤? ºÇÄ¹°ìÃ×? *)</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">MINUS</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'+'</span> <span class="Ccomment">(* +.¤è¤ê¸å²ó¤·¤Ë¤·¤Ê¤¯¤Æ¤âÎÉ¤¤? ºÇÄ¹°ìÃ×? *)</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">PLUS</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"-."</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">MINUS_DOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"+."</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">PLUS_DOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"*."</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">AST_DOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"/."</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">SLASH_DOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'='</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">EQUAL</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"&lt;&gt;"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LESS_GREATER</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"&lt;="</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LESS_EQUAL</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"&gt;="</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">GREATER_EQUAL</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'&lt;'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LESS</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'&gt;'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">GREATER</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"if"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">IF</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"then"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">THEN</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"else"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">ELSE</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"let"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LET</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"in"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">IN</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"rec"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">REC</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">','</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">COMMA</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'_'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">IDENT</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"Array.create"</span> <span class="Ccomment">(* [XX] ad hoc *)</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">ARRAY_CREATE</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">'.'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">DOT</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"&lt;-"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">LESS_MINUS</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">';'</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">SEMICOLON</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> eof
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">EOF</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> lower <span class="Cnonalphakeyword">(</span>digit<span class="Cbar">|</span>lower<span class="Cbar">|</span>upper<span class="Cbar">|</span><span class="Cstring">'_'</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">*</span> <span class="Ccomment">(* Â¾¤Î¡ÖÍ½Ìó¸ì¡×¤è¤ê¸å¤Ç¤Ê¤¤¤È¤¤¤±¤Ê¤¤ *)</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">IDENT</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme lexbuf<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span>
    <span class="Cnonalphakeyword">{</span> failwith
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"unknown token %s near characters %d-%d"</span>
           <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme lexbuf<span class="Cnonalphakeyword">)</span>
           <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme_start lexbuf<span class="Cnonalphakeyword">)</span>
           <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Lexing</span><span class="Cnonalphakeyword">.</span>lexeme_end lexbuf<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cand">and</span> comment <span class="Cnonalphakeyword">=</span> parse
<span class="Cbar">|</span> <span class="Cstring">"*)"</span>
    <span class="Cnonalphakeyword">{</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cstring">"(*"</span>
    <span class="Cnonalphakeyword">{</span> comment lexbuf<span class="Cnonalphakeyword">;</span>
      comment lexbuf <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> eof
    <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"warning: unterminated comment@."</span> <span class="Cnonalphakeyword">}</span>
<span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span>
    <span class="Cnonalphakeyword">{</span> comment lexbuf <span class="Cnonalphakeyword">}</span>
</pre>

<hr>
<h1><a name="typing.mli"></a><code>typing.mli</code></h1>

<pre><span class="Cexception">exception</span> <span class="Cconstructor">Error</span> <span class="Cof">of</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> extenv : <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>t ref
<span class="Cval">val</span> f : <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="typing.ml"></a><code>typing.ml</code></h1>

<pre><span class="Ccomment">(* type inference/reconstruction *)</span>

<span class="Copen">open</span> <span class="Cconstructor">Syntax</span>

<span class="Cexception">exception</span> <span class="Cconstructor">Unify</span> <span class="Cof">of</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t
<span class="Cexception">exception</span> <span class="Cconstructor">Error</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t

<a name="typing_deref"></a><span class="Clet">let</span> extenv <span class="Cnonalphakeyword">=</span> ref <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty

<span class="Ccomment">(* for pretty printing (and type normalization) *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> deref_typ <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ·¿ÊÑ¿ô¤òÃæ¿È¤Ç¤ª¤­¤«¤¨¤ë´Ø¿ô *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span>t1s<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_typ t1s<span class="Cnonalphakeyword">,</span> deref_typ t2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>ts<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_typ ts<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>deref_typ t<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">None</span> <span class="Cnonalphakeyword">}</span> <span class="Cas">as</span> r<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"uninstantiated type variable detected; assuming int@."</span><span class="Cnonalphakeyword">;</span>
      r <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span> <span class="Cas">as</span> r<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> t' <span class="Cnonalphakeyword">=</span> deref_typ t <span class="Cin">in</span>
      r <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      t'
  <span class="Cbar">|</span> t <span class="Cnonalphakeyword">-&gt;</span> t
<span class="Clet">let</span> <span class="Crec">rec</span> deref_id_typ <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> deref_typ t<span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> deref_term <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>deref_term e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>deref_term e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>deref_term e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">,</span> deref_term e3<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>deref_id_typ xt<span class="Cnonalphakeyword">,</span> deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> xt<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> deref_id_typ xt<span class="Cnonalphakeyword">;</span>
               args <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_id_typ yts<span class="Cnonalphakeyword">;</span>
               body <span class="Cnonalphakeyword">=</span> deref_term e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span>
             deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">,</span> es<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>deref_term e<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_term es<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>es<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_term es<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map deref_id_typ xts<span class="Cnonalphakeyword">,</span> deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">)</span>
<a name="typing_occur"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>deref_term e1<span class="Cnonalphakeyword">,</span> deref_term e2<span class="Cnonalphakeyword">,</span> deref_term e3<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e

<span class="Clet">let</span> <span class="Crec">rec</span> occur r1 <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* occur check *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span>t2s<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>exists <span class="Cnonalphakeyword">(</span>occur r1<span class="Cnonalphakeyword">)</span> t2s || occur r1 t2
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>t2s<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>exists <span class="Cnonalphakeyword">(</span>occur r1<span class="Cnonalphakeyword">)</span> t2s
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> occur r1 t2
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>r2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> r1 == r2 <span class="Cnonalphakeyword">-&gt;</span> <span class="Ctrue">true</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">None</span> <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>
<a name="typing_unify"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> occur r1 t2
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>

<span class="Clet">let</span> <span class="Crec">rec</span> unify t1 t2 <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ·¿¤¬¹ç¤¦¤è¤¦¤Ë¡¢·¿ÊÑ¿ô¤Ø¤ÎÂåÆþ¤ò¤¹¤ë *)</span>
  <span class="Cmatch">match</span> t1<span class="Cnonalphakeyword">,</span> t2 <span class="Cwith">with</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span> <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span>t1s<span class="Cnonalphakeyword">,</span> t1'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span>t2s<span class="Cnonalphakeyword">,</span> t2'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Ctry">try</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter2 unify t1s t2s
      <span class="Cwith">with</span> <span class="Cconstructor">Invalid_argument</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"List.iter2"</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      unify t1' t2'
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>t1s<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>t2s<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Ctry">try</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter2 unify t1s t2s
      <span class="Cwith">with</span> <span class="Cconstructor">Invalid_argument</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"List.iter2"</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> unify t1 t2
<a name="typing_undef"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>r1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>r2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> r1 == r2 <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t1'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> unify t1' t2
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t2'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> unify t1 t2'
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">None</span> <span class="Cnonalphakeyword">}</span> <span class="Cas">as</span> r1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* °ìÊý¤¬Ì¤ÄêµÁ¤Î·¿ÊÑ¿ô¤Î¾ì¹ç *)</span>
      <span class="Cif">if</span> occur r1 t2 <span class="Cthen">then</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      r1 <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> contents <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">None</span> <span class="Cnonalphakeyword">}</span> <span class="Cas">as</span> r2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cif">if</span> occur r2 t1 <span class="Cthen">then</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
<a name="typing_g"></a>      r2 <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">Some</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env e <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ·¿¿äÏÀ¥ë¡¼¥Á¥ó *)</span>
  <span class="Ctry">try</span>
    <span class="Cmatch">match</span> e <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span> <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span>
<a name="typing_add"></a>    <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* Â­¤·»»¡Ê¤È°ú¤­»»¡Ë¤Î·¿¿äÏÀ *)</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span>
    <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span>
    <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span>
    <span class="Cbar">|</span> <span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">;</span>
        <span class="Clet">let</span> t2 <span class="Cnonalphakeyword">=</span> g env e2 <span class="Cin">in</span>
<a name="typing_let"></a>        <span class="Clet">let</span> t3 <span class="Cnonalphakeyword">=</span> g env e3 <span class="Cin">in</span>
        unify t2 t3<span class="Cnonalphakeyword">;</span>
        t2
<a name="typing_var"></a>    <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î·¿¿äÏÀ *)</span>
        unify t <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
<a name="typing_extvar"></a>        g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env<span class="Cnonalphakeyword">)</span> e2
    <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Ccomment">(* ÊÑ¿ô¤Î·¿¿äÏÀ *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x !extenv <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x !extenv
    <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ³°ÉôÊÑ¿ô¤Î·¿¿äÏÀ *)</span>
        <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"free variable %s assumed as external@."</span> x<span class="Cnonalphakeyword">;</span>
<a name="typing_letrec"></a>        <span class="Clet">let</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>gentyp <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        extenv <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t !extenv<span class="Cnonalphakeyword">;</span>
        t
    <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let rec¤Î·¿¿äÏÀ *)</span>
<a name="typing_app"></a>        <span class="Clet">let</span> env <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env <span class="Cin">in</span>
        unify t <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map snd yts<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list yts env<span class="Cnonalphakeyword">)</span> e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        g env e2
    <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">,</span> es<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ´Ø¿ôÅ¬ÍÑ¤Î·¿¿äÏÀ *)</span>
        <span class="Clet">let</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>gentyp <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        unify <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span>g env<span class="Cnonalphakeyword">)</span> es<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        t
    <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>es<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span>g env<span class="Cnonalphakeyword">)</span> es<span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        unify <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map snd xts<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list xts env<span class="Cnonalphakeyword">)</span> e2
    <span class="Cbar">|</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* must be a primitive for "polymorphic" typing *)</span>
        unify <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>gentyp <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        unify <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        t
    <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> t <span class="Cnonalphakeyword">=</span> g env e3 <span class="Cin">in</span>
        unify <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
        <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Unify</span><span class="Cnonalphakeyword">(</span>t1<span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Error</span><span class="Cnonalphakeyword">(</span>deref_term e<span class="Cnonalphakeyword">,</span> deref_typ t1<span class="Cnonalphakeyword">,</span> deref_typ t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f e <span class="Cnonalphakeyword">=</span>
  extenv <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">;</span>
<span class="Ccomment">(*</span>
<span class="Ccomment">  (match deref_typ (g M.empty e) with</span>
<span class="Ccomment">  | Type.Unit -&gt; ()</span>
<span class="Ccomment">  | _ -&gt; Format.eprintf "warning: final result does not have type unit@.");</span>
<span class="Ccomment">*)</span>
  <span class="Cnonalphakeyword">(</span><span class="Ctry">try</span> unify <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">(</span>g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e<span class="Cnonalphakeyword">)</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Unify</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> failwith <span class="Cstring">"top level does not have type unit"</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  extenv <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>map deref_typ !extenv<span class="Cnonalphakeyword">;</span>
  deref_term e
</pre>

<hr>
<h1><a name="kNormal.mli"></a><code>kNormal.mli</code></h1>

<pre><span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span> <span class="Cof">of</span> float
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span> <span class="Cof">of</span> fundef <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<span class="Cand">and</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">;</span> args : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span> body : t <span class="Cnonalphakeyword">}</span>

<span class="Cval">val</span> fv : t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> f : <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> t
</pre>

<hr>
<h1><a name="kNormal.ml"></a><code>kNormal.ml</code></h1>
<a name="knormal_t"></a>
<pre><span class="Ccomment">(* give names to intermediate values (K-normalization) *)</span>

<span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* KÀµµ¬²½¸å¤Î¼° *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span> <span class="Cof">of</span> float
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<a name="knormal_branch"></a>  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t <span class="Ccomment">(* Èæ³Ó + Ê¬´ô *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t <span class="Ccomment">(* Èæ³Ó + Ê¬´ô *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span> <span class="Cof">of</span> fundef <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<a name="knormal_fv"></a>  <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<span class="Cand">and</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">;</span> args : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span> body : t <span class="Cnonalphakeyword">}</span>

<span class="Clet">let</span> <span class="Crec">rec</span> fv <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¼°¤Ë½Ð¸½¤¹¤ë¡Ê¼«Í³¤Ê¡ËÊÑ¿ô *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span> <span class="Cbar">|</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add y <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union <span class="Cnonalphakeyword">(</span>fv e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>fv e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union <span class="Cnonalphakeyword">(</span>fv e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>remove x <span class="Cnonalphakeyword">(</span>fv e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> zs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span>fv e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst yts<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union zs <span class="Cnonalphakeyword">(</span>fv e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span>x <span class="Cnonalphakeyword">::</span> ys<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list xs
<a name="knormal_insert"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">;</span> z<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add y <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span>fv e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> insert_let <span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> k <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* let¤òÁÞÆþ¤¹¤ëÊä½õ´Ø¿ô *)</span>
  <span class="Cmatch">match</span> e <span class="Cwith">with</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> k x
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> x <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp t <span class="Cin">in</span>
<a name="knormal_g"></a>      <span class="Clet">let</span> e'<span class="Cnonalphakeyword">,</span> t' <span class="Cnonalphakeyword">=</span> k x <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t'
<a name="knormal_bool"></a>
<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* KÀµµ¬²½¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span>b<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cif">if</span> b <span class="Cthen">then</span> 1 <span class="Celse">else</span> 0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Ccomment">(* ÏÀÍýÃÍtrue, false¤òÀ°¿ô1, 0¤ËÊÑ´¹ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> g env <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Ctrue">true</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="knormal_add"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* Â­¤·»»¤ÎKÀµµ¬²½ *)</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
<a name="knormal_not"></a>            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Eq</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LE</span> <span class="Cnonalphakeyword">_</span> <span class="Cas">as</span> cmp <span class="Cnonalphakeyword">-&gt;</span>
      g env <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>cmp<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Ctrue">true</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Not</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> g env <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* not¤Ë¤è¤ëÊ¬´ô¤òÊÑ´¹ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> e4<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span>
              <span class="Clet">let</span> e3'<span class="Cnonalphakeyword">,</span> t3 <span class="Cnonalphakeyword">=</span> g env e3 <span class="Cin">in</span>
              <span class="Clet">let</span> e4'<span class="Cnonalphakeyword">,</span> t4 <span class="Cnonalphakeyword">=</span> g env e4 <span class="Cin">in</span>
              <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e3'<span class="Cnonalphakeyword">,</span> e4'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LE</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> e4<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span>
<a name="knormal_if"></a>              <span class="Clet">let</span> e3'<span class="Cnonalphakeyword">,</span> t3 <span class="Cnonalphakeyword">=</span> g env e3 <span class="Cin">in</span>
              <span class="Clet">let</span> e4'<span class="Cnonalphakeyword">,</span> t4 <span class="Cnonalphakeyword">=</span> g env e4 <span class="Cin">in</span>
              <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e3'<span class="Cnonalphakeyword">,</span> e4'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> g env <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">If</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Eq</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span><span class="Cnonalphakeyword">(</span><span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* Èæ³Ó¤Î¤Ê¤¤Ê¬´ô¤òÊÑ´¹ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> e1'<span class="Cnonalphakeyword">,</span> t1 <span class="Cnonalphakeyword">=</span> g env e1 <span class="Cin">in</span>
<a name="knormal_extarray"></a>      <span class="Clet">let</span> e2'<span class="Cnonalphakeyword">,</span> t2 <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t2
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ³°ÉôÇÛÎó¤Î»²¾È *)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x !<span class="Cconstructor">Typing</span><span class="Cnonalphakeyword">.</span>extenv <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtArray</span> x<span class="Cnonalphakeyword">,</span> t
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> failwith <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"external variable %s does not have an array type"</span> x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span>body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> env' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env <span class="Cin">in</span>
<a name="knormal_extfunapp"></a>      <span class="Clet">let</span> e2'<span class="Cnonalphakeyword">,</span> t2 <span class="Cnonalphakeyword">=</span> g env' e2 <span class="Cin">in</span>
      <span class="Clet">let</span> e1'<span class="Cnonalphakeyword">,</span> t1 <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list yts env'<span class="Cnonalphakeyword">)</span> e1 <span class="Cin">in</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1' <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t2
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e2s<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem f env<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ³°Éô´Ø¿ô¤Î¸Æ¤Ó½Ð¤· *)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find f !<span class="Cconstructor">Typing</span><span class="Cnonalphakeyword">.</span>extenv <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> <span class="Crec">rec</span> bind xs <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* "xs" are identifiers for the arguments *)</span>
            <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t
            <span class="Cbar">|</span> e2 <span class="Cnonalphakeyword">::</span> e2s <span class="Cnonalphakeyword">-&gt;</span>
                insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
                  <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> bind <span class="Cnonalphakeyword">(</span>xs @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span> e2s<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
          bind <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> e2s <span class="Ccomment">(* left-to-right evaluation *)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2s<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> g env e1 <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> g_e1 <span class="Cnonalphakeyword">-&gt;</span>
          insert_let g_e1
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> f <span class="Cnonalphakeyword">-&gt;</span>
              <span class="Clet">let</span> <span class="Crec">rec</span> bind xs <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* "xs" are identifiers for the arguments *)</span>
                <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t
                <span class="Cbar">|</span> e2 <span class="Cnonalphakeyword">::</span> e2s <span class="Cnonalphakeyword">-&gt;</span>
                    insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
                      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> bind <span class="Cnonalphakeyword">(</span>xs @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span> e2s<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
              bind <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> e2s<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* left-to-right evaluation *)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>es<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> <span class="Crec">rec</span> bind xs ts <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* "xs" and "ts" are identifiers and types for the elements *)</span>
        <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>ts<span class="Cnonalphakeyword">)</span>
        <span class="Cbar">|</span> e <span class="Cnonalphakeyword">::</span> es <span class="Cnonalphakeyword">-&gt;</span>
            <span class="Clet">let</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> t <span class="Cas">as</span> g_e <span class="Cnonalphakeyword">=</span> g env e <span class="Cin">in</span>
            insert_let g_e
              <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> bind <span class="Cnonalphakeyword">(</span>xs @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>ts @ <span class="Cnonalphakeyword">[</span>t<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span> es<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      bind <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> es
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> e2'<span class="Cnonalphakeyword">,</span> t2 <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list xts env<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
          <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> t2 <span class="Cas">as</span> g_e2 <span class="Cnonalphakeyword">=</span> g env e2 <span class="Cin">in</span>
          insert_let g_e2
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span>
              <span class="Clet">let</span> l <span class="Cnonalphakeyword">=</span>
                <span class="Cmatch">match</span> t2 <span class="Cwith">with</span>
                <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"create_float_array"</span>
                <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cstring">"create_array"</span> <span class="Cin">in</span>
              <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> g env e1 <span class="Cwith">with</span>
      <span class="Cbar">|</span>        <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span>t<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> g_e1 <span class="Cnonalphakeyword">-&gt;</span>
          insert_let g_e1
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
                <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Syntax</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      insert_let <span class="Cnonalphakeyword">(</span>g env e1<span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e2<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> insert_let <span class="Cnonalphakeyword">(</span>g env e3<span class="Cnonalphakeyword">)</span>
                <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> z <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f e <span class="Cnonalphakeyword">=</span> fst <span class="Cnonalphakeyword">(</span>g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="alpha.mli"></a><code>alpha.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> g : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* for Inline.g *)</span>
</pre>

<hr>
<h1><a name="alpha.ml"></a><code>alpha.ml</code></h1>

<pre><span class="Ccomment">(* rename identifiers to make them unique (alpha-conversion) *)</span>

<span class="Copen">open</span> <span class="Cconstructor">KNormal</span>
<a name="alpha_g"></a>
<span class="Clet">let</span> find x env <span class="Cnonalphakeyword">=</span> <span class="Ctry">try</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> x

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¦ÁÊÑ´¹¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
<a name="alpha_let"></a>  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î¦ÁÊÑ´¹ *)</span>
<a name="alpha_letrec"></a>      <span class="Clet">let</span> x' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid x <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x'<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x x' env<span class="Cnonalphakeyword">)</span> e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let rec¤Î¦ÁÊÑ´¹ *)</span>
      <span class="Clet">let</span> env <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid x<span class="Cnonalphakeyword">)</span> env <span class="Cin">in</span>
      <span class="Clet">let</span> ys <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst yts <span class="Cin">in</span>
      <span class="Clet">let</span> env' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list2 ys <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid ys<span class="Cnonalphakeyword">)</span> env <span class="Cin">in</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
               args <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>find y env'<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> yts<span class="Cnonalphakeyword">;</span>
               body <span class="Cnonalphakeyword">=</span> g env' e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span>
<a name="alpha_lettuple"></a>             g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> find y env<span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> find x env<span class="Cnonalphakeyword">)</span> xs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* LetTuple¤Î¦ÁÊÑ´¹ *)</span>
      <span class="Clet">let</span> xs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst xts <span class="Cin">in</span>
      <span class="Clet">let</span> env' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list2 xs <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid xs<span class="Cnonalphakeyword">)</span> env <span class="Cin">in</span>
      <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>find x env'<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> xts<span class="Cnonalphakeyword">,</span>
               find y env<span class="Cnonalphakeyword">,</span>
               g env' e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> find z env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> find y env<span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty
</pre>

<hr>
<h1><a name="beta.mli"></a><code>beta.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="beta.ml"></a><code>beta.ml</code></h1>
<a name="beta_find"></a>
<pre><span class="Copen">open</span> <span class="Cconstructor">KNormal</span>
<a name="beta_g"></a>
<span class="Clet">let</span> find x env <span class="Cnonalphakeyword">=</span> <span class="Ctry">try</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Ccomment">(* ÃÖ´¹¤Î¤¿¤á¤Î´Ø¿ô *)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¦Â´ÊÌó¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
<a name="beta_let"></a>  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î¦Â´ÊÌó *)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> g env e1 <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"beta-reducing %s = %s@."</span> x y<span class="Cnonalphakeyword">;</span>
          g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x y env<span class="Cnonalphakeyword">)</span> e2
      <span class="Cbar">|</span> e1' <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> g env e2 <span class="Cin">in</span>
<a name="beta_var"></a>          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> xt<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> xt<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> g env e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* ÊÑ¿ô¤òÃÖ´¹ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> find x env<span class="Cnonalphakeyword">)</span> xs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> g env e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>find x env<span class="Cnonalphakeyword">,</span> find y env<span class="Cnonalphakeyword">,</span> find z env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>g<span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>find g env<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> find x env<span class="Cnonalphakeyword">)</span> xs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> find y env<span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty
</pre>

<hr>
<h1><a name="assoc.mli"></a><code>assoc.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="assoc.ml"></a><code>assoc.ml</code></h1>

<pre><span class="Ccomment">(* flatten let-bindings (just for prettier printing) *)</span>
<a name="assoc_f"></a>
<span class="Copen">open</span> <span class="Cconstructor">KNormal</span>

<a name="assoc_let"></a><span class="Clet">let</span> <span class="Crec">rec</span> f <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¥Í¥¹¥È¤·¤¿let¤Î´ÊÌó *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> f e1<span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> f e1<span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î¾ì¹ç *)</span>
      <span class="Clet">let</span> <span class="Crec">rec</span> insert <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
        <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>yt<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> e4<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>yt<span class="Cnonalphakeyword">,</span> e3<span class="Cnonalphakeyword">,</span> insert e4<span class="Cnonalphakeyword">)</span>
        <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span>fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span>fundefs<span class="Cnonalphakeyword">,</span> insert e<span class="Cnonalphakeyword">)</span>
        <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>yts<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>yts<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">,</span> insert e<span class="Cnonalphakeyword">)</span>
        <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      insert <span class="Cnonalphakeyword">(</span>f e1<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> xt<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> xt<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> f e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> f e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e
</pre>

<hr>
<h1><a name="inline.mli"></a><code>inline.mli</code></h1>

<pre><span class="Cval">val</span> threshold : int ref
<span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="inline.ml"></a><code>inline.ml</code></h1>
<a name="inline_threshold"></a>
<pre><span class="Copen">open</span> <span class="Cconstructor">KNormal</span>

<span class="Ccomment">(* ¥¤¥ó¥é¥¤¥óÅ¸³«¤¹¤ë´Ø¿ô¤ÎºÇÂç¥µ¥¤¥º *)</span>
<span class="Clet">let</span> threshold <span class="Cnonalphakeyword">=</span> ref 0 <span class="Ccomment">(* Main¤Ç-inline¥ª¥×¥·¥ç¥ó¤Ë¤è¤ê¥»¥Ã¥È¤µ¤ì¤ë *)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> size <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 1 <span class="Cnonalphakeyword">+</span> size e1 <span class="Cnonalphakeyword">+</span> size e2
<a name="inline_g"></a>  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 1 <span class="Cnonalphakeyword">+</span> size e
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> 1

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¥¤¥ó¥é¥¤¥óÅ¸³«¥ë¡¼¥Á¥óËÜÂÎ *)</span>
<a name="inline_letrec"></a>  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
<a name="inline_app"></a>  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ´Ø¿ôÄêµÁ¤Î¾ì¹ç *)</span>
      <span class="Clet">let</span> env <span class="Cnonalphakeyword">=</span> <span class="Cif">if</span> size e1 <span class="Cnonalphakeyword">&gt;</span> !threshold <span class="Cthen">then</span> env <span class="Celse">else</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x <span class="Cnonalphakeyword">(</span>yts<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">)</span> env <span class="Cin">in</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> g env e1<span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ´Ø¿ôÅ¬ÍÑ¤Î¾ì¹ç *)</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>zs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cin">in</span>
      <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"inlining %s@."</span> x<span class="Cnonalphakeyword">;</span>
      <span class="Clet">let</span> env' <span class="Cnonalphakeyword">=</span>
        <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left2
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> env' <span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add z y env'<span class="Cnonalphakeyword">)</span>
          <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty
          zs
          ys <span class="Cin">in</span>
      <span class="Cconstructor">Alpha</span><span class="Cnonalphakeyword">.</span>g env' e
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e

<span class="Clet">let</span> f e <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e
</pre>

<hr>
<h1><a name="constFold.mli"></a><code>constFold.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="constFold.ml"></a><code>constFold.ml</code></h1>

<pre><span class="Copen">open</span> <span class="Cconstructor">KNormal</span>

<span class="Clet">let</span> memi x env <span class="Cnonalphakeyword">=</span>
  <span class="Ctry">try</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ctrue">true</span> <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>
<span class="Clet">let</span> memf x env <span class="Cnonalphakeyword">=</span>
  <span class="Ctry">try</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ctrue">true</span> <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>
<span class="Clet">let</span> memt x env <span class="Cnonalphakeyword">=</span>
  <span class="Ctry">try</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ctrue">true</span> <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>

<span class="Clet">let</span> findi x env <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> i <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cconstructor">Not_found</span><span class="Cnonalphakeyword">)</span>
<a name="constfold_g"></a><span class="Clet">let</span> findf x env <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> d <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cconstructor">Not_found</span><span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> findt x env <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> ys <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cconstructor">Not_found</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* Äê¿ô¾ö¤ß¹þ¤ß¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>findi x env<span class="Cnonalphakeyword">)</span>
<a name="constfold_add"></a>  <span class="Ccomment">(* | Var(x) when memf x env -&gt; Float(findf x env) *)</span>
  <span class="Ccomment">(* | Var(x) when memt x env -&gt; Tuple(findt x env) *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">-</span><span class="Cnonalphakeyword">(</span>findi x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">&amp;&amp;</span> memi y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>findi x env <span class="Cnonalphakeyword">+</span> findi y env<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* Â­¤·»»¤Î¥±¡¼¥¹ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">&amp;&amp;</span> memi y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>findi x env <span class="Cnonalphakeyword">-</span> findi y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">-.</span><span class="Cnonalphakeyword">(</span>findf x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>findf x env +. findf y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>findf x env <span class="Cnonalphakeyword">-.</span> findf y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>findf x env *. findf y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>findf x env /. findf y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">&amp;&amp;</span> memi y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> findi x env <span class="Cnonalphakeyword">=</span> findi y env <span class="Cthen">then</span> g env e1 <span class="Celse">else</span> g env e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> findf x env <span class="Cnonalphakeyword">=</span> findf y env <span class="Cthen">then</span> g env e1 <span class="Celse">else</span> g env e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
<a name="constfold_let"></a>  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memi x env <span class="Cnonalphakeyword">&amp;&amp;</span> memi y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> findi x env &lt;= findi y env <span class="Cthen">then</span> g env e1 <span class="Celse">else</span> g env e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memf x env <span class="Cnonalphakeyword">&amp;&amp;</span> memf y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> findf x env &lt;= findf y env <span class="Cthen">then</span> g env e1 <span class="Celse">else</span> g env e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î¥±¡¼¥¹ *)</span>
      <span class="Clet">let</span> e1' <span class="Cnonalphakeyword">=</span> g env e1 <span class="Cin">in</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x e1' env<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> x<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> ys<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> x<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> ys<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> g env e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> memt y env <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left2
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e' xt z <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span>g env e<span class="Cnonalphakeyword">)</span>
        xts
        <span class="Cnonalphakeyword">(</span>findt y env<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e

<span class="Clet">let</span> f <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty
</pre>

<hr>
<h1><a name="elim.mli"></a><code>elim.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t
</pre>

<hr>
<h1><a name="elim.ml"></a><code>elim.ml</code></h1>
<a name="elim_effect"></a>
<pre><span class="Copen">open</span> <span class="Cconstructor">KNormal</span>

<span class="Clet">let</span> <span class="Crec">rec</span> effect <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ÉûºîÍÑ¤ÎÍ­Ìµ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> effect e1 || effect e2
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> effect e
<a name="elim_f"></a>  <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">ExtFunApp</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ctrue">true</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span>

<a name="elim_let"></a><span class="Clet">let</span> <span class="Crec">rec</span> f <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ÉÔÍ×ÄêµÁºï½ü¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> f e1<span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> f e1<span class="Cnonalphakeyword">,</span> f e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let¤Î¾ì¹ç *)</span>
      <span class="Clet">let</span> e1' <span class="Cnonalphakeyword">=</span> f e1 <span class="Cin">in</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> f e2 <span class="Cin">in</span>
<a name="elim_letrec"></a>      <span class="Cif">if</span> effect e1' || <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x <span class="Cnonalphakeyword">(</span>fv e2'<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span> <span class="Celse">else</span>
      <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"eliminating variable %s@."</span> x<span class="Cnonalphakeyword">;</span>
       e2'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* let rec¤Î¾ì¹ç *)</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> f e2 <span class="Cin">in</span>
      <span class="Cif">if</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x <span class="Cnonalphakeyword">(</span>fv e2'<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
        <span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> f e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span>
      <span class="Celse">else</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"eliminating function %s@."</span> x<span class="Cnonalphakeyword">;</span>
         e2'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> xs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst xts <span class="Cin">in</span>
      <span class="Clet">let</span> e' <span class="Cnonalphakeyword">=</span> f e <span class="Cin">in</span>
      <span class="Clet">let</span> live <span class="Cnonalphakeyword">=</span> fv e' <span class="Cin">in</span>
      <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>exists <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x live<span class="Cnonalphakeyword">)</span> xs <span class="Cthen">then</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span> <span class="Celse">else</span>
      <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"eliminating variables %s@."</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>pp_list xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
       e'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e
</pre>

<hr>
<h1><a name="closure.mli"></a><code>closure.mli</code></h1>

<pre><span class="Ctype">type</span> closure <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> entry : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l<span class="Cnonalphakeyword">;</span> actual_fv : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">}</span>
<span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span> <span class="Cof">of</span> float
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">MakeCls</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> closure <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">AppCls</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">AppDir</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l
<span class="Ctype">type</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">;</span>
                args : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span>
                formal_fv : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span>
                body : t <span class="Cnonalphakeyword">}</span>
<span class="Ctype">type</span> prog <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Prog</span> <span class="Cof">of</span> fundef list <span class="Cnonalphakeyword">*</span> t

<span class="Cval">val</span> fv : t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> f : <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> prog
</pre>

<hr>
<a name="closure_t"></a><h1><a name="closure.ml"></a><code>closure.ml</code></h1>

<pre><span class="Ctype">type</span> closure <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> entry : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l<span class="Cnonalphakeyword">;</span> actual_fv : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">}</span>
<span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥¯¥í¡¼¥¸¥ãÊÑ´¹¸å¤Î¼° *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Int</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">Float</span> <span class="Cof">of</span> float
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FSub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMul</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">MakeCls</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> closure <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">AppCls</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">AppDir</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">Get</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l
<span class="Ctype">type</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">;</span>
                args : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span>
                formal_fv : <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> list<span class="Cnonalphakeyword">;</span>
                body : t <span class="Cnonalphakeyword">}</span>
<span class="Ctype">type</span> prog <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Prog</span> <span class="Cof">of</span> fundef list <span class="Cnonalphakeyword">*</span> t

<span class="Clet">let</span> <span class="Crec">rec</span> fv <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Unit</span> <span class="Cbar">|</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add y <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union <span class="Cnonalphakeyword">(</span>fv e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>fv e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union <span class="Cnonalphakeyword">(</span>fv e1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>remove x <span class="Cnonalphakeyword">(</span>fv e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x
  <span class="Cbar">|</span> <span class="Cconstructor">MakeCls</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">{</span> entry <span class="Cnonalphakeyword">=</span> l<span class="Cnonalphakeyword">;</span> actual_fv <span class="Cnonalphakeyword">=</span> ys <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>remove x <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>union <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>fv e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">AppCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span>x <span class="Cnonalphakeyword">::</span> ys<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">AppDir</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list xs
  <span class="Cbar">|</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add y <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span>fv e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst xts<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">;</span> z<span class="Cnonalphakeyword">]</span>
<a name="closure_g"></a>
<span class="Clet">let</span> toplevel : fundef list ref <span class="Cnonalphakeyword">=</span> ref <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env known <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¥¯¥í¡¼¥¸¥ãÊÑ´¹¥ë¡¼¥Á¥óËÜÂÎ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Unit</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env known e1<span class="Cnonalphakeyword">,</span> g env known e2<span class="Cnonalphakeyword">)</span>
<a name="closure_letrec"></a>  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env known e1<span class="Cnonalphakeyword">,</span> g env known e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env known e1<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env<span class="Cnonalphakeyword">)</span> known e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LetRec</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">{</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span>body <span class="Cnonalphakeyword">=</span> e1 <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ´Ø¿ôÄêµÁ¤Î¾ì¹ç *)</span>
      <span class="Ccomment">(* ´Ø¿ôÄêµÁlet rec x y1 ... yn = e1 in e2¤Î¾ì¹ç¤Ï¡¢</span>
<span class="Ccomment"></span>        <span class="Ccomment"> x¤Ë¼«Í³ÊÑ¿ô¤¬¤Ê¤¤(closure¤ò²ð¤µ¤ºdirect¤Ë¸Æ¤Ó½Ð¤»¤ë)</span>
<span class="Ccomment"></span>        <span class="Ccomment"> ¤È²¾Äê¤·¡¢known¤ËÄÉ²Ã¤·¤Æe1¤ò¥¯¥í¡¼¥¸¥ãÊÑ´¹¤·¤Æ¤ß¤ë *)</span>
      <span class="Clet">let</span> toplevel_backup <span class="Cnonalphakeyword">=</span> !toplevel <span class="Cin">in</span>
      <span class="Clet">let</span> env' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env <span class="Cin">in</span>
      <span class="Clet">let</span> known' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x known <span class="Cin">in</span>
      <span class="Clet">let</span> e1' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list yts env'<span class="Cnonalphakeyword">)</span> known' e1 <span class="Cin">in</span>
      <span class="Ccomment">(* ËÜÅö¤Ë¼«Í³ÊÑ¿ô¤¬¤Ê¤«¤Ã¤¿¤«¡¢ÊÑ´¹·ë²Ìe1'¤ò³ÎÇ§¤¹¤ë *)</span>
      <span class="Ccomment">(* Ãí°Õ: e1'¤Ëx¼«¿È¤¬ÊÑ¿ô¤È¤·¤Æ½Ð¸½¤¹¤ë¾ì¹ç¤Ïclosure¤¬É¬Í×!</span>
<span class="Ccomment">         (thanks to nuevo-namasute and azounoman; test/cls-bug2.ml»²¾È) *)</span>
      <span class="Clet">let</span> zs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span>fv e1'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst yts<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Clet">let</span> known'<span class="Cnonalphakeyword">,</span> e1' <span class="Cnonalphakeyword">=</span>
        <span class="Cif">if</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>is_empty zs <span class="Cthen">then</span> known'<span class="Cnonalphakeyword">,</span> e1' <span class="Celse">else</span>
        <span class="Ccomment">(* ÂÌÌÜ¤À¤Ã¤¿¤é¾õÂÖ(toplevel¤ÎÃÍ)¤òÌá¤·¤Æ¡¢¥¯¥í¡¼¥¸¥ãÊÑ´¹¤ò¤ä¤êÄ¾¤¹ *)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"free variable(s) %s found in function %s@."</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>pp_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>elements zs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> x<span class="Cnonalphakeyword">;</span>
         <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"function %s cannot be directly applied in fact@."</span> x<span class="Cnonalphakeyword">;</span>
         toplevel <span class="Cnonalphakeyword">:=</span> toplevel_backup<span class="Cnonalphakeyword">;</span>
         <span class="Clet">let</span> e1' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list yts env'<span class="Cnonalphakeyword">)</span> known e1 <span class="Cin">in</span>
         known<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Clet">let</span> zs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>elements <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>diff <span class="Cnonalphakeyword">(</span>fv e1'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>of_list <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map fst yts<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span> <span class="Ccomment">(* ¼«Í³ÊÑ¿ô¤Î¥ê¥¹¥È *)</span>
      <span class="Clet">let</span> zts <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> z <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find z env'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> zs <span class="Cin">in</span> <span class="Ccomment">(* ¤³¤³¤Ç¼«Í³ÊÑ¿ôz¤Î·¿¤ò°ú¤¯¤¿¤á¤Ë°ú¿ôenv¤¬É¬Í× *)</span>
      toplevel <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> formal_fv <span class="Cnonalphakeyword">=</span> zts<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e1' <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">::</span> !toplevel<span class="Cnonalphakeyword">;</span> <span class="Ccomment">(* ¥È¥Ã¥×¥ì¥Ù¥ë´Ø¿ô¤òÄÉ²Ã *)</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> g env' known' e2 <span class="Cin">in</span>
      <span class="Cif">if</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x <span class="Cnonalphakeyword">(</span>fv e2'<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> <span class="Ccomment">(* x¤¬ÊÑ¿ô¤È¤·¤Æe2'¤Ë½Ð¸½¤¹¤ë¤« *)</span>
        <span class="Cconstructor">MakeCls</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">{</span> entry <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> actual_fv <span class="Cnonalphakeyword">=</span> zs <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* ½Ð¸½¤·¤Æ¤¤¤¿¤éºï½ü¤·¤Ê¤¤ *)</span>
<a name="closure_app"></a>      <span class="Celse">else</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"eliminating closure(s) %s@."</span> x<span class="Cnonalphakeyword">;</span>
         e2'<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* ½Ð¸½¤·¤Ê¤±¤ì¤ÐMakeCls¤òºï½ü *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x known <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ´Ø¿ôÅ¬ÍÑ¤Î¾ì¹ç *)</span>
      <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"directly applying %s@."</span> x<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">AppDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">App</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">AppCls</span><span class="Cnonalphakeyword">(</span>f<span class="Cnonalphakeyword">,</span> xs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list xts env<span class="Cnonalphakeyword">)</span> known e<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">KNormal</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">ExtFunApp</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">AppDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"min_caml_"</span> ^ x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f e <span class="Cnonalphakeyword">=</span>
  toplevel <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> e' <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty e <span class="Cin">in</span>
  <span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>rev !toplevel<span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="asm.mli"></a><code>asm.mli</code></h1>

<pre><span class="Ctype">type</span> id_or_imm <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">V</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cbar">|</span> <span class="Cconstructor">C</span> <span class="Cof">of</span> int
<span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span> <span class="Cof">of</span> exp
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> exp <span class="Cnonalphakeyword">*</span> t
<span class="Cand">and</span> exp <span class="Cnonalphakeyword">=</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Nop</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Set</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">SetL</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l
  <span class="Cbar">|</span> <span class="Cconstructor">Mov</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">SLL</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Ld</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">St</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">FMovD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNegD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAddD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FSubD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMulD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDivD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">StDF</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Comment</span> <span class="Cof">of</span> string
  <span class="Ccomment">(* virtual instructions *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Ccomment">(* closure address, integer arguments, and float arguments *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">CallCls</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">CallDir</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">Save</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* ¥ì¥¸¥¹¥¿ÊÑ¿ô¤ÎÃÍ¤ò¥¹¥¿¥Ã¥¯ÊÑ¿ô¤ØÊÝÂ¸ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Restore</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* ¥¹¥¿¥Ã¥¯ÊÑ¿ô¤«¤éÃÍ¤òÉü¸µ *)</span>
<span class="Ctype">type</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l<span class="Cnonalphakeyword">;</span> args : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list<span class="Cnonalphakeyword">;</span> fargs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list<span class="Cnonalphakeyword">;</span> body : t<span class="Cnonalphakeyword">;</span> ret : <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">}</span>
<span class="Ctype">type</span> prog <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Prog</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> float<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> fundef list <span class="Cnonalphakeyword">*</span> t

<span class="Cval">val</span> fletd : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> exp <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">-&gt;</span> t <span class="Ccomment">(* shorthand of Let for float *)</span>
<span class="Cval">val</span> seq : exp <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">-&gt;</span> t <span class="Ccomment">(* shorthand of Let for unit *)</span>

<span class="Cval">val</span> regs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t array
<span class="Cval">val</span> fregs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t array
<span class="Cval">val</span> allregs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<span class="Cval">val</span> allfregs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<span class="Cval">val</span> reg_cl : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> reg_sw : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> reg_fsw : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> reg_ra : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> reg_hp : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> reg_sp : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
<span class="Cval">val</span> is_reg : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> bool
<span class="Cval">val</span> co_freg : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t

<span class="Cval">val</span> fv : t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<span class="Cval">val</span> concat : t <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> t

<span class="Cval">val</span> align : int <span class="Cnonalphakeyword">-&gt;</span> int
</pre>

<hr>
<h1><a name="asm.ml"></a><code>asm.ml</code></h1>

<a name="sparcasm_t"></a><pre><span class="Ccomment">(* SPARC assembly with a few virtual instructions *)</span>

<span class="Ctype">type</span> id_or_imm <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">V</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cbar">|</span> <span class="Cconstructor">C</span> <span class="Cof">of</span> int
<a name="sparcasm_exp"></a><span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* Ì¿Îá¤ÎÎó *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span> <span class="Cof">of</span> exp
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> exp <span class="Cnonalphakeyword">*</span> t
<span class="Cand">and</span> exp <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* °ì¤Ä°ì¤Ä¤ÎÌ¿Îá¤ËÂÐ±þ¤¹¤ë¼° *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Nop</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Set</span> <span class="Cof">of</span> int
  <span class="Cbar">|</span> <span class="Cconstructor">SetL</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l
  <span class="Cbar">|</span> <span class="Cconstructor">Mov</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">SLL</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Ld</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">St</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">FMovD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FNegD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FAddD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FSubD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FMulD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">FDivD</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t
  <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">StDF</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm
  <span class="Cbar">|</span> <span class="Cconstructor">Comment</span> <span class="Cof">of</span> string
  <span class="Ccomment">(* virtual instructions *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> id_or_imm <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t <span class="Ccomment">(* º¸±¦ÂÐ¾Î¤Ç¤Ï¤Ê¤¤¤Î¤ÇÉ¬Í× *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
  <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> t
<a name="sparcasm_save"></a>  <span class="Ccomment">(* closure address, integer arguments, and float arguments *)</span>
<a name="sparcasm_restore"></a>  <span class="Cbar">|</span> <span class="Cconstructor">CallCls</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
  <span class="Cbar">|</span> <span class="Cconstructor">CallDir</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list
<a name="sparcasm_prog"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Save</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* ¥ì¥¸¥¹¥¿ÊÑ¿ô¤ÎÃÍ¤ò¥¹¥¿¥Ã¥¯ÊÑ¿ô¤ØÊÝÂ¸ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Restore</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* ¥¹¥¿¥Ã¥¯ÊÑ¿ô¤«¤éÃÍ¤òÉü¸µ *)</span>
<span class="Ctype">type</span> fundef <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span> name : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l<span class="Cnonalphakeyword">;</span> args : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list<span class="Cnonalphakeyword">;</span> fargs : <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t list<span class="Cnonalphakeyword">;</span> body : t<span class="Cnonalphakeyword">;</span> ret : <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">}</span>
<span class="Ccomment">(* ¥×¥í¥°¥é¥àÁ´ÂÎ = ÉâÆ°¾®¿ôÅÀ¿ô¥Æ¡¼¥Ö¥ë + ¥È¥Ã¥×¥ì¥Ù¥ë´Ø¿ô + ¥á¥¤¥ó¤Î¼° *)</span>
<span class="Ctype">type</span> prog <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Prog</span> <span class="Cof">of</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>l <span class="Cnonalphakeyword">*</span> float<span class="Cnonalphakeyword">)</span> list <span class="Cnonalphakeyword">*</span> fundef list <span class="Cnonalphakeyword">*</span> t

<span class="Clet">let</span> fletd<span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> seq<span class="Cnonalphakeyword">(</span>e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> regs <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* Array.init 16 (fun i -&gt; Printf.sprintf "%%r%d" i) *)</span>
  <span class="Cnonalphakeyword">[|</span> <span class="Cstring">"%i2"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%i3"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%i4"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%i5"</span><span class="Cnonalphakeyword">;</span>
     <span class="Cstring">"%l0"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l1"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l2"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l3"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l4"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l5"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l6"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%l7"</span><span class="Cnonalphakeyword">;</span>
     <span class="Cstring">"%o0"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%o1"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%o2"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%o3"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%o4"</span><span class="Cnonalphakeyword">;</span> <span class="Cstring">"%o5"</span> <span class="Cnonalphakeyword">|]</span>
<a name="sparcasm_regcl"></a><span class="Clet">let</span> fregs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>init 16 <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> i <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"%%f%d"</span> <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">*</span> 2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> allregs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>to_list regs
<span class="Clet">let</span> allfregs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>to_list fregs
<span class="Clet">let</span> reg_cl <span class="Cnonalphakeyword">=</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>length regs <span class="Cnonalphakeyword">-</span> 1<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* closure address *)</span>
<a name="sparcasm_reghp"></a><span class="Clet">let</span> reg_sw <span class="Cnonalphakeyword">=</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>length regs <span class="Cnonalphakeyword">-</span> 2<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* temporary for swap *)</span>
<span class="Clet">let</span> reg_fsw <span class="Cnonalphakeyword">=</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>length fregs <span class="Cnonalphakeyword">-</span> 1<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* temporary for swap *)</span>
<span class="Clet">let</span> reg_sp <span class="Cnonalphakeyword">=</span> <span class="Cstring">"%i0"</span> <span class="Ccomment">(* stack pointer *)</span>
<span class="Clet">let</span> reg_hp <span class="Cnonalphakeyword">=</span> <span class="Cstring">"%i1"</span> <span class="Ccomment">(* heap pointer *)</span>
<span class="Clet">let</span> reg_ra <span class="Cnonalphakeyword">=</span> <span class="Cstring">"%o7"</span> <span class="Ccomment">(* return address *)</span>
<span class="Clet">let</span> is_reg x <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">[</span>0<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">=</span> <span class="Cstring">'%'</span><span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> co_freg_table <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> ht <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Hashtbl</span><span class="Cnonalphakeyword">.</span>create 16 <span class="Cin">in</span>
  <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> 0 <span class="Cto">to</span> 15 <span class="Cdo">do</span>
    <span class="Cconstructor">Hashtbl</span><span class="Cnonalphakeyword">.</span>add
      ht
      <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"%%f%d"</span> <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">*</span> 2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>sprintf <span class="Cstring">"%%f%d"</span> <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">*</span> 2 <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cdone">done</span><span class="Cnonalphakeyword">;</span>
  ht
<span class="Clet">let</span> co_freg freg <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Hashtbl</span><span class="Cnonalphakeyword">.</span>find co_freg_table freg <span class="Ccomment">(* "companion" freg *)</span>

<span class="Ccomment">(* super-tenuki *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> remove_and_uniq xs <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
<a name="sparcasm_fv"></a>  <span class="Cbar">|</span> x <span class="Cnonalphakeyword">::</span> ys <span class="Cwhen">when</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x xs <span class="Cnonalphakeyword">-&gt;</span> remove_and_uniq xs ys
  <span class="Cbar">|</span> x <span class="Cnonalphakeyword">::</span> ys <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> remove_and_uniq <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x xs<span class="Cnonalphakeyword">)</span> ys

<span class="Ccomment">(* free variables in the order of use (for spilling) *)</span>
<span class="Clet">let</span> fv_id_or_imm <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span> <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
<span class="Clet">let</span> <span class="Crec">rec</span> fv_exp <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Nop</span> <span class="Cbar">|</span> <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">SetL</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Comment</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Restore</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FNegD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> fv_id_or_imm y'
  <span class="Cbar">|</span> <span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> y <span class="Cnonalphakeyword">::</span> fv_id_or_imm z'
  <span class="Cbar">|</span> <span class="Cconstructor">FAddD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FSubD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FMulD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">FDivD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> y<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> fv_id_or_imm y' @ remove_and_uniq <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty <span class="Cnonalphakeyword">(</span>fv e1 @ fv e2<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* uniq here just for efficiency *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> y <span class="Cnonalphakeyword">::</span> remove_and_uniq <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty <span class="Cnonalphakeyword">(</span>fv e1 @ fv e2<span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* uniq here just for efficiency *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">::</span> ys @ zs
  <span class="Cbar">|</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> ys @ zs
<span class="Cand">and</span> fv <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> fv_exp exp
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      fv_exp exp @ remove_and_uniq <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>fv e<span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> fv e <span class="Cnonalphakeyword">=</span> remove_and_uniq <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty <span class="Cnonalphakeyword">(</span>fv e<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> concat e1 xt e2 <span class="Cnonalphakeyword">=</span>
  <span class="Cmatch">match</span> e1 <span class="Cwith">with</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>yt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>yt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> concat e1' xt e2<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> align i <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cif">if</span> i <span class="Cmod">mod</span> 8 <span class="Cnonalphakeyword">=</span> 0 <span class="Cthen">then</span> i <span class="Celse">else</span> i <span class="Cnonalphakeyword">+</span> 4<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="virtual.mli"></a><code>virtual.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>prog <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog
</pre>

<hr>
<h1><a name="virtual.ml"></a><code>virtual.ml</code></h1>

<pre><span class="Ccomment">(* translation into SPARC assembly with infinite number of virtual registers *)</span>
<a name="virtual_data"></a>
<span class="Copen">open</span> <span class="Cconstructor">Asm</span>

<span class="Clet">let</span> data <span class="Cnonalphakeyword">=</span> ref <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Ccomment">(* ÉâÆ°¾®¿ôÅÀ¿ô¤ÎÄê¿ô¥Æ¡¼¥Ö¥ë *)</span>

<span class="Clet">let</span> classify xts ini addf addi <span class="Cnonalphakeyword">=</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> acc <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cmatch">match</span> t <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> acc
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> addf acc x
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> addi acc x t<span class="Cnonalphakeyword">)</span>
    ini
    xts

<span class="Clet">let</span> separate xts <span class="Cnonalphakeyword">=</span>
  classify
    xts
    <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span> x <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>int @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> expand xts ini addf addi <span class="Cnonalphakeyword">=</span>
  classify
    xts
    ini
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> acc<span class="Cnonalphakeyword">)</span> x <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> offset <span class="Cnonalphakeyword">=</span> align offset <span class="Cin">in</span>
      <span class="Cnonalphakeyword">(</span>offset <span class="Cnonalphakeyword">+</span> 8<span class="Cnonalphakeyword">,</span> addf x offset acc<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="virtual_g"></a>    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> acc<span class="Cnonalphakeyword">)</span> x t <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span>offset <span class="Cnonalphakeyword">+</span> 4<span class="Cnonalphakeyword">,</span> addi x t offset acc<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ¼°¤Î²¾ÁÛ¥Þ¥·¥ó¥³¡¼¥ÉÀ¸À® *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> l <span class="Cnonalphakeyword">=</span>
        <span class="Ctry">try</span>
          <span class="Ccomment">(* ¤¹¤Ç¤ËÄê¿ô¥Æ¡¼¥Ö¥ë¤Ë¤¢¤Ã¤¿¤éºÆÍøÍÑ *)</span>
          <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>find <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> d'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> d <span class="Cnonalphakeyword">=</span> d'<span class="Cnonalphakeyword">)</span> !data <span class="Cin">in</span>
          l
        <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> l <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"l"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
          data <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">,</span> d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> !data<span class="Cnonalphakeyword">;</span>
          l <span class="Cin">in</span>
      <span class="Clet">let</span> x <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"l"</span> <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SetL</span><span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FNeg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FNegD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FAdd</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FAddD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FSub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FSubD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FMul</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FMulD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">FDiv</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FDivD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span> <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> failwith <span class="Cstring">"equality supported only for bool, int, and float"</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Bool</span> <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> failwith <span class="Cstring">"inequality supported only for bool, int, and float"</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> e1' <span class="Cnonalphakeyword">=</span> g env e1 <span class="Cin">in</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t1 env<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
      concat e1' <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t1<span class="Cnonalphakeyword">)</span> e2'
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Var</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span>
<a name="virtual_makecls"></a>      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">MakeCls</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>entry <span class="Cnonalphakeyword">=</span> l<span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>actual_fv <span class="Cnonalphakeyword">=</span> ys <span class="Cnonalphakeyword">}</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ¥¯¥í¡¼¥¸¥ã¤ÎÀ¸À® *)</span>
      <span class="Ccomment">(* Closure¤Î¥¢¥É¥ì¥¹¤ò¥»¥Ã¥È¤·¤Æ¤«¤é¡¢¼«Í³ÊÑ¿ô¤ÎÃÍ¤ò¥¹¥È¥¢ *)</span>
      <span class="Clet">let</span> e2' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t env<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
      <span class="Clet">let</span> offset<span class="Cnonalphakeyword">,</span> store_fv <span class="Cnonalphakeyword">=</span>
        expand
          <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span>4<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y offset store_fv <span class="Cnonalphakeyword">-&gt;</span> seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> store_fv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">_</span> offset store_fv <span class="Cnonalphakeyword">-&gt;</span> seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> store_fv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>align offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              <span class="Clet">let</span> z <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"l"</span> <span class="Cin">in</span>
              <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SetL</span><span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
                  seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
                      store_fv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">AppCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> separate <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="virtual_tuple"></a>  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">AppDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> separate <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span>xs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ÁÈ¤ÎÀ¸À® *)</span>
      <span class="Clet">let</span> y <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"t"</span> <span class="Cin">in</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> store<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
        expand
          <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> xs<span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x offset store <span class="Cnonalphakeyword">-&gt;</span> seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> store<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">_</span> offset store <span class="Cnonalphakeyword">-&gt;</span> seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> store<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Tuple</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span> xs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>reg_hp<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>align offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              store<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">LetTuple</span><span class="Cnonalphakeyword">(</span>xts<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> s <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>fv e2 <span class="Cin">in</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
        expand
          xts
          <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list xts env<span class="Cnonalphakeyword">)</span> e2<span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x offset load <span class="Cnonalphakeyword">-&gt;</span>
            <span class="Cif">if</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x s<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> load <span class="Celse">else</span> <span class="Ccomment">(* [XX] a little ad hoc optimization *)</span>
            fletd<span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
          <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> x t offset load <span class="Cnonalphakeyword">-&gt;</span>
<a name="virtual_get"></a>            <span class="Cif">if</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem x s<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> load <span class="Celse">else</span> <span class="Ccomment">(* [XX] a little ad hoc optimization *)</span>
            <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      load
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Get</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ÇÛÎó¤ÎÆÉ¤ß½Ð¤· *)</span>
      <span class="Clet">let</span> offset <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"o"</span> <span class="Cin">in</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Put</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> offset <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cstring">"o"</span> <span class="Cin">in</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>3<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
              <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="virtual_h"></a>      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">ExtArray</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">SetL</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"min_caml_"</span> ^ x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

<span class="Ccomment">(* ´Ø¿ô¤Î²¾ÁÛ¥Þ¥·¥ó¥³¡¼¥ÉÀ¸À® *)</span>
<span class="Clet">let</span> h <span class="Cnonalphakeyword">{</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>name <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>args <span class="Cnonalphakeyword">=</span> yts<span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>formal_fv <span class="Cnonalphakeyword">=</span> zts<span class="Cnonalphakeyword">;</span> <span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span>body <span class="Cnonalphakeyword">=</span> e <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>int<span class="Cnonalphakeyword">,</span> float<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> separate yts <span class="Cin">in</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
    expand
      zts
      <span class="Cnonalphakeyword">(</span>4<span class="Cnonalphakeyword">,</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x t <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list yts <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add_list zts <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e<span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> z offset load <span class="Cnonalphakeyword">-&gt;</span> fletd<span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>reg_cl<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> z t offset load <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>reg_cl<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>offset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> load<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Cmatch">match</span> t <span class="Cwith">with</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Fun</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> t2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
<a name="virtual_f"></a>      <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> int<span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> float<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> load<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> t2 <span class="Cnonalphakeyword">}</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span>

<span class="Ccomment">(* ¥×¥í¥°¥é¥àÁ´ÂÎ¤Î²¾ÁÛ¥Þ¥·¥ó¥³¡¼¥ÉÀ¸À® *)</span>
<span class="Clet">let</span> f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Closure</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
  data <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> fundefs <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map h fundefs <span class="Cin">in</span>
  <span class="Clet">let</span> e <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e <span class="Cin">in</span>
  <span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>!data<span class="Cnonalphakeyword">,</span> fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="simm.mli"></a><code>simm.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog
</pre>

<hr>
<h1><a name="simm.ml"></a><code>simm.ml</code></h1>
<a name="simm13_g"></a>
<pre><span class="Copen">open</span> <span class="Cconstructor">Asm</span>

<span class="Clet">let</span> <span class="Crec">rec</span> g env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* Ì¿ÎáÎó¤Î13bitÂ¨ÃÍºÇÅ¬²½ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>g' env exp<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cnonalphakeyword">(</span>-4096 &lt;= i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">&amp;&amp;</span> <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">&lt;</span> 4096<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Ccomment">(* Format.eprintf "found simm13 %s = %d@." x i; *)</span>
      <span class="Clet">let</span> e' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x i env<span class="Cnonalphakeyword">)</span> e <span class="Cin">in</span>
      <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x <span class="Cnonalphakeyword">(</span>fv e'<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span> <span class="Celse">else</span>
      <span class="Cnonalphakeyword">(</span><span class="Ccomment">(* Format.eprintf "erased redundant Set to %s@." x; *)</span>
       e'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* for array access *)</span>
<a name="simm13_gprime"></a>      <span class="Ccomment">(* Format.eprintf "erased redundant SLL on %s@." x; *)</span>
      g env <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span> <span class="Clsl">lsl</span> i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> g' env exp<span class="Cnonalphakeyword">,</span> g env e<span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g' env <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ³ÆÌ¿Îá¤Î13bitÂ¨ÃÍºÇÅ¬²½ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem z env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find z env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem z env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find z env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem y env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x env <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x env<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> g env e1<span class="Cnonalphakeyword">,</span> g env e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> e <span class="Cnonalphakeyword">-&gt;</span> e

<span class="Clet">let</span> h <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> l<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> xs<span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> ys<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> t <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥È¥Ã¥×¥ì¥Ù¥ë´Ø¿ô¤Î13bitÂ¨ÃÍºÇÅ¬²½ *)</span>
  <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> l<span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> xs<span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> ys<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> t <span class="Cnonalphakeyword">}</span>

<span class="Clet">let</span> f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>data<span class="Cnonalphakeyword">,</span> fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥×¥í¥°¥é¥àÁ´ÂÎ¤Î13bitÂ¨ÃÍºÇÅ¬²½ *)</span>
  <span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>data<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map h fundefs<span class="Cnonalphakeyword">,</span> g <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="regAlloc.mli"></a><code>regAlloc.mli</code></h1>

<pre><span class="Cval">val</span> f : <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog
</pre>

<hr>
<h1><a name="regAlloc.ml"></a><code>regAlloc.ml</code></h1>

<pre><span class="Copen">open</span> <span class="Cconstructor">Asm</span>

<span class="Ccomment">(* for register coalescing *)</span>
<span class="Ccomment">(* [XXX] Call¤¬¤¢¤Ã¤¿¤é¡¢¤½¤³¤«¤éÀè¤ÏÌµ°ÕÌ£¤È¤¤¤¦¤«µÕ¸ú²Ì¤Ê¤Î¤ÇÄÉ¤ï¤Ê¤¤¡£</span>
<span class="Ccomment">         ¤½¤Î¤¿¤á¤Ë¡ÖCall¤¬¤¢¤Ã¤¿¤«¤É¤¦¤«¡×¤òÊÖ¤êÃÍ¤ÎÂè1Í×ÁÇ¤Ë´Þ¤á¤ë¡£ *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> target' src <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> x <span class="Cnonalphakeyword">=</span> src <span class="Cnonalphakeyword">&amp;&amp;</span> is_reg dest <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>t &lt;&gt; <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>t &lt;&gt; <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cfalse">false</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span>dest<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> x <span class="Cnonalphakeyword">=</span> src <span class="Cnonalphakeyword">&amp;&amp;</span> is_reg dest <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cfalse">false</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span>dest<span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> c1<span class="Cnonalphakeyword">,</span> rs1 <span class="Cnonalphakeyword">=</span> target src <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> e1 <span class="Cin">in</span>
      <span class="Clet">let</span> c2<span class="Cnonalphakeyword">,</span> rs2 <span class="Cnonalphakeyword">=</span> target src <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> e2 <span class="Cin">in</span>
      c1 <span class="Cnonalphakeyword">&amp;&amp;</span> c2<span class="Cnonalphakeyword">,</span> rs1 @ rs2
  <span class="Cbar">|</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Ctrue">true</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span>target_args src regs 0 ys @
             target_args src fregs 0 zs @
             <span class="Cif">if</span> x <span class="Cnonalphakeyword">=</span> src <span class="Cthen">then</span> <span class="Cnonalphakeyword">[</span>reg_cl<span class="Cnonalphakeyword">]</span> <span class="Celse">else</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
<a name="regalloc_target"></a>      <span class="Ctrue">true</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span>target_args src regs 0 ys @
             target_args src fregs 0 zs<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
<span class="Cand">and</span> target src dest <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* register targeting *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> target' src dest exp
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span>xt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Clet">let</span> c1<span class="Cnonalphakeyword">,</span> rs1 <span class="Cnonalphakeyword">=</span> target' src xt exp <span class="Cin">in</span>
      <span class="Cif">if</span> c1 <span class="Cthen">then</span> <span class="Ctrue">true</span><span class="Cnonalphakeyword">,</span> rs1 <span class="Celse">else</span>
      <span class="Clet">let</span> c2<span class="Cnonalphakeyword">,</span> rs2 <span class="Cnonalphakeyword">=</span> target src dest e <span class="Cin">in</span>
      c2<span class="Cnonalphakeyword">,</span> rs1 @ rs2
<span class="Cand">and</span> target_args src all n <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* auxiliary function for Call *)</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> y <span class="Cnonalphakeyword">::</span> ys <span class="Cwhen">when</span> src <span class="Cnonalphakeyword">=</span> y <span class="Cnonalphakeyword">-&gt;</span> all<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>n<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> target_args src all <span class="Cnonalphakeyword">(</span>n <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">)</span> ys
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">::</span> ys <span class="Cnonalphakeyword">-&gt;</span> target_args src all <span class="Cnonalphakeyword">(</span>n <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">)</span> ys

<span class="Ctype">type</span> alloc_result <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* alloc¤Ë¤ª¤¤¤Æspilling¤¬¤¢¤Ã¤¿¤«¤É¤¦¤«¤òÉ½¤¹¥Ç¡¼¥¿·¿ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Alloc</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* allocated register *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Spill</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* spilled variable *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> alloc dest cont regenv x t <span class="Cnonalphakeyword">=</span>
  <span class="Ccomment">(* allocate a register or spill a variable *)</span>
  <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> all <span class="Cnonalphakeyword">=</span>
    <span class="Cmatch">match</span> t <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">"%g0"</span><span class="Cnonalphakeyword">]</span> <span class="Ccomment">(* dummy *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> allfregs
    <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> allregs <span class="Cin">in</span>
  <span class="Cif">if</span> all <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[</span><span class="Cstring">"%g0"</span><span class="Cnonalphakeyword">]</span> <span class="Cthen">then</span> <span class="Cconstructor">Alloc</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"%g0"</span><span class="Cnonalphakeyword">)</span> <span class="Celse">else</span> <span class="Ccomment">(* [XX] ad hoc optimization *)</span>
  <span class="Cif">if</span> is_reg x <span class="Cthen">then</span> <span class="Cconstructor">Alloc</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Celse">else</span>
  <span class="Clet">let</span> free <span class="Cnonalphakeyword">=</span> fv cont <span class="Cin">in</span>
  <span class="Ctry">try</span>
    <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>c<span class="Cnonalphakeyword">,</span> prefer<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> target x dest cont <span class="Cin">in</span>
    <span class="Clet">let</span> live <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* À¸¤­¤Æ¤¤¤ë¥ì¥¸¥¹¥¿ *)</span>
      <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> live y <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cif">if</span> is_reg y <span class="Cthen">then</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add y live <span class="Celse">else</span>
          <span class="Ctry">try</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y regenv<span class="Cnonalphakeyword">)</span> live
          <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> live<span class="Cnonalphakeyword">)</span>
        <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty
        free <span class="Cin">in</span>
    <span class="Clet">let</span> r <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¤½¤¦¤Ç¤Ê¤¤¥ì¥¸¥¹¥¿¤òÃµ¤¹ *)</span>
      <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>find
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> r <span class="Cnonalphakeyword">-&gt;</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem r live<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span>prefer @ all<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
    <span class="Ccomment">(* Format.eprintf "allocated %s to %s@." x r; *)</span>
    <span class="Cconstructor">Alloc</span><span class="Cnonalphakeyword">(</span>r<span class="Cnonalphakeyword">)</span>
  <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span>
    <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"register allocation failed for %s@."</span> x<span class="Cnonalphakeyword">;</span>
    <span class="Clet">let</span> y <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ·¿¤Î¹ç¤¦¥ì¥¸¥¹¥¿ÊÑ¿ô¤òÃµ¤¹ *)</span>
      <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>find
        <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span>
          not <span class="Cnonalphakeyword">(</span>is_reg y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">&amp;&amp;</span>
          <span class="Ctry">try</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y regenv<span class="Cnonalphakeyword">)</span> all
          <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>rev free<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
    <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"spilling %s from %s@."</span> y <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
    <span class="Cconstructor">Spill</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span>

<span class="Ccomment">(* auxiliary function for g and g'_and_restore *)</span>
<span class="Clet">let</span> add x r regenv <span class="Cnonalphakeyword">=</span>
  <span class="Cif">if</span> is_reg x <span class="Cthen">then</span> <span class="Cnonalphakeyword">(</span><span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>x <span class="Cnonalphakeyword">=</span> r<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> regenv<span class="Cnonalphakeyword">)</span> <span class="Celse">else</span>
  <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x r regenv

<span class="Ccomment">(* auxiliary functions for g' *)</span>
<span class="Cexception">exception</span> <span class="Cconstructor">NoReg</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span>t
<span class="Clet">let</span> find x t regenv <span class="Cnonalphakeyword">=</span>
  <span class="Cif">if</span> is_reg x <span class="Cthen">then</span> x <span class="Celse">else</span>
  <span class="Ctry">try</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x regenv
  <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> raise <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NoReg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> find' x' regenv <span class="Cnonalphakeyword">=</span>
  <span class="Cmatch">match</span> x' <span class="Cwith">with</span>
<a name="regalloc_g"></a>  <span class="Cbar">|</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> c <span class="Cnonalphakeyword">-&gt;</span> c

<span class="Clet">let</span> <span class="Crec">rec</span> g dest cont regenv <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* Ì¿ÎáÎó¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> g'_and_restore dest cont regenv exp
  <span class="Cbar">|</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> xt<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Clet">let</span> cont' <span class="Cnonalphakeyword">=</span> concat e dest cont <span class="Cin">in</span>
      <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e1'<span class="Cnonalphakeyword">,</span> regenv1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g'_and_restore xt cont' regenv exp <span class="Cin">in</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> alloc dest cont' regenv1 x t <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Spill</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> r <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y regenv1 <span class="Cin">in</span>
          <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e2'<span class="Cnonalphakeyword">,</span> regenv2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g dest cont <span class="Cnonalphakeyword">(</span>add x r <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>remove y regenv1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e <span class="Cin">in</span>
          <span class="Clet">let</span> save <span class="Cnonalphakeyword">=</span>
            <span class="Ctry">try</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find y regenv<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span>
            <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Nop</span> <span class="Cin">in</span>            
          <span class="Cnonalphakeyword">(</span>seq<span class="Cnonalphakeyword">(</span>save<span class="Cnonalphakeyword">,</span> concat e1' <span class="Cnonalphakeyword">(</span>r<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv2<span class="Cnonalphakeyword">)</span>
<a name="regalloc_unspill"></a>      <span class="Cbar">|</span> <span class="Cconstructor">Alloc</span><span class="Cnonalphakeyword">(</span>r<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e2'<span class="Cnonalphakeyword">,</span> regenv2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g dest cont <span class="Cnonalphakeyword">(</span>add x r regenv1<span class="Cnonalphakeyword">)</span> e <span class="Cin">in</span>
          <span class="Cnonalphakeyword">(</span>concat e1' <span class="Cnonalphakeyword">(</span>r<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> e2'<span class="Cnonalphakeyword">,</span> regenv2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g'_and_restore dest cont regenv exp <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* »ÈÍÑ¤µ¤ì¤ëÊÑ¿ô¤ò¥¹¥¿¥Ã¥¯¤«¤é¥ì¥¸¥¹¥¿¤ØRestore *)</span>
  <span class="Ctry">try</span> g' dest cont regenv exp
<a name="regalloc_gprime"></a>  <span class="Cwith">with</span> <span class="Cconstructor">NoReg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
    <span class="Cnonalphakeyword">(</span><span class="Ccomment">(* Format.eprintf "restoring %s@." x; *)</span>
     g dest cont regenv <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Restore</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g' dest cont regenv <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ³ÆÌ¿Îá¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Nop</span> <span class="Cbar">|</span> <span class="Cconstructor">Set</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">SetL</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Comment</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Restore</span> <span class="Cnonalphakeyword">_</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' z' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FNegD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FNegD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FAddD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FAddD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FSubD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FSubD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FMulD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FMulD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">FDivD</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">FDivD</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' z' regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_if dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e1' e2' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_if dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e1' e2' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_if dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e1' e2' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> find' y' regenv<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_if dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e1' e2' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2
  <span class="Cbar">|</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_if dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e1' e2' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">,</span> e1'<span class="Cnonalphakeyword">,</span> e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2
<a name="regalloc_if"></a>  <span class="Cbar">|</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_call dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> ys zs <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>find x <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> ys zs
  <span class="Cbar">|</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp <span class="Cnonalphakeyword">-&gt;</span> g'_call dest cont regenv exp <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> ys zs <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span>l<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> ys zs
  <span class="Cbar">|</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span>
<span class="Cand">and</span> g'_if dest cont regenv exp constr e1 e2 <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* if¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e1'<span class="Cnonalphakeyword">,</span> regenv1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g dest cont regenv e1 <span class="Cin">in</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e2'<span class="Cnonalphakeyword">,</span> regenv2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g dest cont regenv e2 <span class="Cin">in</span>
  <span class="Clet">let</span> regenv' <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* Î¾Êý¤Ë¶¦ÄÌ¤Î¥ì¥¸¥¹¥¿ÊÑ¿ô¤À¤±ÍøÍÑ *)</span>
    <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> regenv' x <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Ctry">try</span>
          <span class="Cif">if</span> is_reg x <span class="Cthen">then</span> regenv' <span class="Celse">else</span>
          <span class="Clet">let</span> r1 <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x regenv1 <span class="Cin">in</span>
          <span class="Clet">let</span> r2 <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x regenv2 <span class="Cin">in</span>
          <span class="Cif">if</span> r1 &lt;&gt; r2 <span class="Cthen">then</span> regenv' <span class="Celse">else</span>
          <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x r1 regenv'
        <span class="Cwith">with</span> <span class="Cconstructor">Not_found</span> <span class="Cnonalphakeyword">-&gt;</span> regenv'<span class="Cnonalphakeyword">)</span>
      <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty
      <span class="Cnonalphakeyword">(</span>fv cont<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
     <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e x <span class="Cnonalphakeyword">-&gt;</span>
       <span class="Cif">if</span> x <span class="Cnonalphakeyword">=</span> fst dest || not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x regenv<span class="Cnonalphakeyword">)</span> || <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x regenv' <span class="Cthen">then</span> e <span class="Celse">else</span>
       seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x regenv<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* ¤½¤¦¤Ç¤Ê¤¤ÊÑ¿ô¤ÏÊ¬´ôÄ¾Á°¤Ë¥»¡¼¥Ö *)</span>
<a name="regalloc_call"></a>     <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>constr e1' e2'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
     <span class="Cnonalphakeyword">(</span>fv cont<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
   regenv'<span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g'_call dest cont regenv exp constr ys zs <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ´Ø¿ô¸Æ¤Ó½Ð¤·¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
     <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> e x <span class="Cnonalphakeyword">-&gt;</span>
       <span class="Cif">if</span> x <span class="Cnonalphakeyword">=</span> fst dest || not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>mem x regenv<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span> e <span class="Celse">else</span>
       seq<span class="Cnonalphakeyword">(</span><span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>find x regenv<span class="Cnonalphakeyword">,</span> x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
     <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>constr
            <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> y <span class="Cnonalphakeyword">-&gt;</span> find y <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span> regenv<span class="Cnonalphakeyword">)</span> ys<span class="Cnonalphakeyword">)</span>
            <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> z <span class="Cnonalphakeyword">-&gt;</span> find z <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> regenv<span class="Cnonalphakeyword">)</span> zs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<a name="regalloc_h"></a>     <span class="Cnonalphakeyword">(</span>fv cont<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
   <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> h <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> ys<span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> zs<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> t <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ´Ø¿ô¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Clet">let</span> regenv <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add x reg_cl <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty <span class="Cin">in</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">,</span> arg_regs<span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
    <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">,</span> arg_regs<span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span> y <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> r <span class="Cnonalphakeyword">=</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">,</span>
         arg_regs @ <span class="Cnonalphakeyword">[</span>r<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span>
         <span class="Cnonalphakeyword">(</span><span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>not <span class="Cnonalphakeyword">(</span>is_reg y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
          <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add y r regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
      ys <span class="Cin">in</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">,</span> farg_regs<span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
    <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">,</span> farg_regs<span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span> z <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> fr <span class="Cnonalphakeyword">=</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        <span class="Cnonalphakeyword">(</span>d <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">,</span>
         farg_regs @ <span class="Cnonalphakeyword">[</span>fr<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span>
         <span class="Cnonalphakeyword">(</span><span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span>not <span class="Cnonalphakeyword">(</span>is_reg z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
          <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>add z fr regenv<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span> regenv<span class="Cnonalphakeyword">)</span>
      zs <span class="Cin">in</span>
  <span class="Clet">let</span> a <span class="Cnonalphakeyword">=</span>
    <span class="Cmatch">match</span> t <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Float</span> <span class="Cnonalphakeyword">-&gt;</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
<a name="regalloc_f"></a>  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>e'<span class="Cnonalphakeyword">,</span> regenv'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span>a<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>a<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> regenv e <span class="Cin">in</span>
  <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> arg_regs<span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> farg_regs<span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e'<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> t <span class="Cnonalphakeyword">}</span>

<span class="Clet">let</span> f <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>data<span class="Cnonalphakeyword">,</span> fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* ¥×¥í¥°¥é¥àÁ´ÂÎ¤Î¥ì¥¸¥¹¥¿³ä¤êÅö¤Æ *)</span>
  <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"register allocation: may take some time (up to a few minutes, depending on the size of functions)@."</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> fundefs' <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map h fundefs <span class="Cin">in</span>
  <span class="Clet">let</span> e'<span class="Cnonalphakeyword">,</span> regenv' <span class="Cnonalphakeyword">=</span> g <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cconstructor">M</span><span class="Cnonalphakeyword">.</span>empty e <span class="Cin">in</span>
  <span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>data<span class="Cnonalphakeyword">,</span> fundefs'<span class="Cnonalphakeyword">,</span> e'<span class="Cnonalphakeyword">)</span>
</pre>

<hr>
<h1><a name="emit.mli"></a><code>emit.mli</code></h1>

<pre><span class="Cval">val</span> f : out_channel <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Asm</span><span class="Cnonalphakeyword">.</span>prog <span class="Cnonalphakeyword">-&gt;</span> unit
</pre>

<hr>
<h1><a name="emit.ml"></a><code>emit.ml</code></h1>

<pre><span class="Copen">open</span> <span class="Cconstructor">Asm</span>

<a name="emit_stackset"></a><span class="Cexternal">external</span> gethi : float <span class="Cnonalphakeyword">-&gt;</span> int32 <span class="Cnonalphakeyword">=</span> <span class="Cstring">"gethi"</span>
<a name="emit_stackmap"></a><span class="Cexternal">external</span> getlo : float <span class="Cnonalphakeyword">-&gt;</span> int32 <span class="Cnonalphakeyword">=</span> <span class="Cstring">"getlo"</span>

<span class="Clet">let</span> stackset <span class="Cnonalphakeyword">=</span> ref <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty <span class="Ccomment">(* ¤¹¤Ç¤ËSave¤µ¤ì¤¿ÊÑ¿ô¤Î½¸¹ç *)</span>
<span class="Clet">let</span> stackmap <span class="Cnonalphakeyword">=</span> ref <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Ccomment">(* Save¤µ¤ì¤¿ÊÑ¿ô¤Î¡¢¥¹¥¿¥Ã¥¯¤Ë¤ª¤±¤ë°ÌÃÖ *)</span>
<span class="Clet">let</span> save x <span class="Cnonalphakeyword">=</span>
  stackset <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x !stackset<span class="Cnonalphakeyword">;</span>
  <span class="Cif">if</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x !stackmap<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
    stackmap <span class="Cnonalphakeyword">:=</span> !stackmap @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">]</span>
<span class="Clet">let</span> savef x <span class="Cnonalphakeyword">=</span>
  stackset <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>add x !stackset<span class="Cnonalphakeyword">;</span>
  <span class="Cif">if</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x !stackmap<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
    <span class="Cnonalphakeyword">(</span><span class="Clet">let</span> pad <span class="Cnonalphakeyword">=</span>
      <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>length !stackmap <span class="Cmod">mod</span> 2 <span class="Cnonalphakeyword">=</span> 0 <span class="Cthen">then</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Celse">else</span> <span class="Cnonalphakeyword">[</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Int</span><span class="Cnonalphakeyword">]</span> <span class="Cin">in</span>
    stackmap <span class="Cnonalphakeyword">:=</span> !stackmap @ pad @ <span class="Cnonalphakeyword">[</span>x<span class="Cnonalphakeyword">;</span> x<span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> locate x <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> loc <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
    <span class="Cbar">|</span> y <span class="Cnonalphakeyword">::</span> zs <span class="Cwhen">when</span> x <span class="Cnonalphakeyword">=</span> y <span class="Cnonalphakeyword">-&gt;</span> 0 <span class="Cnonalphakeyword">::</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map succ <span class="Cnonalphakeyword">(</span>loc zs<span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> y <span class="Cnonalphakeyword">::</span> zs <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map succ <span class="Cnonalphakeyword">(</span>loc zs<span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  loc !stackmap
<span class="Clet">let</span> offset x <span class="Cnonalphakeyword">=</span> 4 <span class="Cnonalphakeyword">*</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>hd <span class="Cnonalphakeyword">(</span>locate x<span class="Cnonalphakeyword">)</span>
<span class="Clet">let</span> stacksize <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> align <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>length !stackmap <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">*</span> 4<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> pp_id_or_imm <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
<a name="emit_shuffle"></a>  <span class="Cbar">|</span> <span class="Cconstructor">V</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">C</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> string_of_int i

<span class="Ccomment">(* ´Ø¿ô¸Æ¤Ó½Ð¤·¤Î¤¿¤á¤Ë°ú¿ô¤òÊÂ¤ÙÂØ¤¨¤ë(register shuffling) *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> shuffle sw xys <span class="Cnonalphakeyword">=</span>
  <span class="Ccomment">(* remove identical moves *)</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> xys <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>partition <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> x <span class="Cnonalphakeyword">=</span> y<span class="Cnonalphakeyword">)</span> xys <span class="Cin">in</span>
  <span class="Ccomment">(* find acyclic moves *)</span>
  <span class="Cmatch">match</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>partition <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem_assoc y xys<span class="Cnonalphakeyword">)</span> xys <span class="Cwith">with</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span>
  <span class="Cbar">|</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> xys<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* no acyclic moves; resolve a cyclic move *)</span>
      <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> sw<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> <span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> shuffle sw <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>map
                                         <span class="Cnonalphakeyword">(</span><span class="Cfunction">function</span>
                                           <span class="Cbar">|</span> <span class="Cnonalphakeyword">(</span>y'<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> y <span class="Cnonalphakeyword">=</span> y' <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>sw<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span>
                                           <span class="Cbar">|</span> yz <span class="Cnonalphakeyword">-&gt;</span> yz<span class="Cnonalphakeyword">)</span>
<a name="emit_dest"></a>                                         xys<span class="Cnonalphakeyword">)</span>
<a name="emit_g"></a>  <span class="Cbar">|</span> xys<span class="Cnonalphakeyword">,</span> acyc <span class="Cnonalphakeyword">-&gt;</span> acyc @ shuffle sw xys

<span class="Ctype">type</span> dest <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Tail</span> <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span> <span class="Cof">of</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>t <span class="Ccomment">(* ËöÈø¤«¤É¤¦¤«¤òÉ½¤¹¥Ç¡¼¥¿·¿ *)</span>
<span class="Clet">let</span> <span class="Crec">rec</span> g oc <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* Ì¿ÎáÎó¤Î¥¢¥»¥ó¥Ö¥êÀ¸À® *)</span>
  <span class="Cbar">|</span> dest<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ans</span><span class="Cnonalphakeyword">(</span>exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> g' oc <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span>
<a name="emit_gprime"></a>  <span class="Cbar">|</span> dest<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Let</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> t<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
<a name="emit_nontail"></a>      g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g oc <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g' oc <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Ccomment">(* ³ÆÌ¿Îá¤Î¥¢¥»¥ó¥Ö¥êÀ¸À® *)</span>
  <span class="Ccomment">(* ËöÈø¤Ç¤Ê¤«¤Ã¤¿¤é·×»»·ë²Ì¤òdest¤Ë¥»¥Ã¥È *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Nop</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Set</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tset\t%d, %s\n"</span> i x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SetL</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tset\t%s, %s\n"</span> y x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> x <span class="Cnonalphakeyword">=</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Mov</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tmov\t%s, %s\n"</span> y x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Neg</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tneg\t%s, %s\n"</span> y x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Add</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tadd\t%s, %s, %s\n"</span> y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Sub</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tsub\t%s, %s, %s\n"</span> y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">SLL</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tsll\t%s, %s, %s\n"</span> y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Ld</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + %s], %s\n"</span> y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">St</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tst\t%s, [%s + %s]\n"</span> x y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> x <span class="Cnonalphakeyword">=</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FMovD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> y x<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> <span class="Cnonalphakeyword">(</span>co_freg y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>co_freg x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FNegD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfnegs\t%s, %s\n"</span> y x<span class="Cnonalphakeyword">;</span>
      <span class="Cif">if</span> x &lt;&gt; y <span class="Cthen">then</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> <span class="Cnonalphakeyword">(</span>co_freg y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>co_freg x<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FAddD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfaddd\t%s, %s, %s\n"</span> y z x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FSubD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfsubd\t%s, %s, %s\n"</span> y z x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FMulD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmuld\t%s, %s, %s\n"</span> y z x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">FDivD</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfdivd\t%s, %s, %s\n"</span> y z x
<a name="emit_save"></a>  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">LdDF</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tldd\t[%s + %s], %s\n"</span> y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span> x
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">StDF</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> z'<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tstd\t%s, [%s + %s]\n"</span> x y <span class="Cnonalphakeyword">(</span>pp_id_or_imm z'<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Comment</span><span class="Cnonalphakeyword">(</span>s<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\t! %s\n"</span> s
  <span class="Ccomment">(* ÂàÈò¤Î²¾ÁÛÌ¿Îá¤Î¼ÂÁõ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x allregs <span class="Cnonalphakeyword">&amp;&amp;</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem y !stackset<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      save y<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tst\t%s, [%s + %d]\n"</span> x reg_sp <span class="Cnonalphakeyword">(</span>offset y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x allfregs <span class="Cnonalphakeyword">&amp;&amp;</span> not <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem y !stackset<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
<a name="emit_restore"></a>      savef y<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tstd\t%s, [%s + %d]\n"</span> x reg_sp <span class="Cnonalphakeyword">(</span>offset y<span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Save</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>mem y !stackset<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span>
  <span class="Ccomment">(* Éüµ¢¤Î²¾ÁÛÌ¿Îá¤Î¼ÂÁõ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Restore</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x allregs <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + %d], %s\n"</span> reg_sp <span class="Cnonalphakeyword">(</span>offset y<span class="Cnonalphakeyword">)</span> x
<a name="emit_tailret"></a>  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Restore</span><span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem x allfregs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tldd\t[%s + %d], %s\n"</span> reg_sp <span class="Cnonalphakeyword">(</span>offset y<span class="Cnonalphakeyword">)</span> x
  <span class="Ccomment">(* ËöÈø¤À¤Ã¤¿¤é·×»»·ë²Ì¤òÂè°ì¥ì¥¸¥¹¥¿¤Ë¥»¥Ã¥È¤·¤Æret *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Nop</span> <span class="Cbar">|</span> <span class="Cconstructor">St</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">StDF</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Comment</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Save</span> <span class="Cnonalphakeyword">_</span> <span class="Cas">as</span> exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>gentmp <span class="Cconstructor">Type</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">Unit</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tretl\n"</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Set</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">SetL</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Mov</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Neg</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Add</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Sub</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">SLL</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">Ld</span> <span class="Cnonalphakeyword">_</span> <span class="Cas">as</span> exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tretl\n"</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">FMovD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">FNegD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">FAddD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">FSubD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">FMulD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">FDivD</span> <span class="Cnonalphakeyword">_</span> <span class="Cbar">|</span> <span class="Cconstructor">LdDF</span> <span class="Cnonalphakeyword">_</span>  <span class="Cas">as</span> exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tretl\n"</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Restore</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> exp<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cnonalphakeyword">(</span><span class="Cmatch">match</span> locate x <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span>i<span class="Cnonalphakeyword">]</span> <span class="Cnonalphakeyword">-&gt;</span> g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">[</span>i<span class="Cnonalphakeyword">;</span> j<span class="Cnonalphakeyword">]</span> <span class="Cwhen">when</span> i <span class="Cnonalphakeyword">+</span> 1 <span class="Cnonalphakeyword">=</span> j <span class="Cnonalphakeyword">-&gt;</span> g' oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> exp<span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cassert">assert</span> <span class="Cfalse">false</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tretl\n"</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_tail_if oc e1 e2 <span class="Cstring">"be"</span> <span class="Cstring">"bne"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_tail_if oc e1 e2 <span class="Cstring">"ble"</span> <span class="Cstring">"bg"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_tail_if oc e1 e2 <span class="Cstring">"bge"</span> <span class="Cstring">"bl"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfcmpd\t%s, %s\n"</span> x y<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
      g'_tail_if oc e1 e2 <span class="Cstring">"fbe"</span> <span class="Cstring">"fbne"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfcmpd\t%s, %s\n"</span> x y<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
      g'_tail_if oc e1 e2 <span class="Cstring">"fble"</span> <span class="Cstring">"fbg"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_non_tail_if oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2 <span class="Cstring">"be"</span> <span class="Cstring">"bne"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_non_tail_if oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2 <span class="Cstring">"ble"</span> <span class="Cstring">"bg"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfGE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y'<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcmp\t%s, %s\n"</span> x <span class="Cnonalphakeyword">(</span>pp_id_or_imm y'<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      g'_non_tail_if oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2 <span class="Cstring">"bge"</span> <span class="Cstring">"bl"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfFEq</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfcmpd\t%s, %s\n"</span> x y<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
      g'_non_tail_if oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2 <span class="Cstring">"fbe"</span> <span class="Cstring">"fbne"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">IfFLE</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> y<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
<a name="emit_call"></a>      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfcmpd\t%s, %s\n"</span> x y<span class="Cnonalphakeyword">;</span>
<a name="emit_tailcall"></a>      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
      g'_non_tail_if oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> e1 e2 <span class="Cstring">"fble"</span> <span class="Cstring">"fbg"</span>
  <span class="Ccomment">(* ´Ø¿ô¸Æ¤Ó½Ð¤·¤Î²¾ÁÛÌ¿Îá¤Î¼ÂÁõ *)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ËöÈø¸Æ¤Ó½Ð¤· *)</span>
      g'_args oc <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> reg_cl<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">]</span> ys zs<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + 0], %s\n"</span> reg_cl reg_sw<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tjmp\t%s\n"</span> reg_sw<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* ËöÈø¸Æ¤Ó½Ð¤· *)</span>
      g'_args oc <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> ys zs<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tb\t%s\n"</span> x<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>a<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">CallCls</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      g'_args oc <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">,</span> reg_cl<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">]</span> ys zs<span class="Cnonalphakeyword">;</span>
      <span class="Clet">let</span> ss <span class="Cnonalphakeyword">=</span> stacksize <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tst\t%s, [%s + %d]\n"</span> reg_ra reg_sp <span class="Cnonalphakeyword">(</span>ss <span class="Cnonalphakeyword">-</span> 4<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + 0], %s\n"</span> reg_cl reg_sw<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcall\t%s\n"</span> reg_sw<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tadd\t%s, %d, %s\t! delay slot\n"</span> reg_sp ss reg_sp<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tsub\t%s, %d, %s\n"</span> reg_sp ss reg_sp<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + %d], %s\n"</span> reg_sp <span class="Cnonalphakeyword">(</span>ss <span class="Cnonalphakeyword">-</span> 4<span class="Cnonalphakeyword">)</span> reg_ra<span class="Cnonalphakeyword">;</span>
      <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem a allregs <span class="Cnonalphakeyword">&amp;&amp;</span> a &lt;&gt; regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
        <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tmov\t%s, %s\n"</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> a
      <span class="Celse">else</span> <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem a allfregs <span class="Cnonalphakeyword">&amp;&amp;</span> a &lt;&gt; fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> a<span class="Cnonalphakeyword">;</span>
         <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> <span class="Cnonalphakeyword">(</span>co_freg fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>co_freg a<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Cbar">|</span> <span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span>a<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">CallDir</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> ys<span class="Cnonalphakeyword">,</span> zs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      g'_args oc <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span> ys zs<span class="Cnonalphakeyword">;</span>
      <span class="Clet">let</span> ss <span class="Cnonalphakeyword">=</span> stacksize <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tst\t%s, [%s + %d]\n"</span> reg_ra reg_sp <span class="Cnonalphakeyword">(</span>ss <span class="Cnonalphakeyword">-</span> 4<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tcall\t%s\n"</span> x<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tadd\t%s, %d, %s\t! delay slot\n"</span> reg_sp ss reg_sp<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tsub\t%s, %d, %s\n"</span> reg_sp ss reg_sp<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tld\t[%s + %d], %s\n"</span> reg_sp <span class="Cnonalphakeyword">(</span>ss <span class="Cnonalphakeyword">-</span> 4<span class="Cnonalphakeyword">)</span> reg_ra<span class="Cnonalphakeyword">;</span>
      <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem a allregs <span class="Cnonalphakeyword">&amp;&amp;</span> a &lt;&gt; regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
        <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tmov\t%s, %s\n"</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> a
      <span class="Celse">else</span> <span class="Cif">if</span> <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>mem a allfregs <span class="Cnonalphakeyword">&amp;&amp;</span> a &lt;&gt; fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> <span class="Cthen">then</span>
        <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span> a<span class="Cnonalphakeyword">;</span>
         <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> <span class="Cnonalphakeyword">(</span>co_freg fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>co_freg a<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g'_tail_if oc e1 e2 b bn <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> b_else <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cnonalphakeyword">(</span>b ^ <span class="Cstring">"_else"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\t%s\t%s\n"</span> bn b_else<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> stackset_back <span class="Cnonalphakeyword">=</span> !stackset <span class="Cin">in</span>
  g oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"%s:\n"</span> b_else<span class="Cnonalphakeyword">;</span>
  stackset <span class="Cnonalphakeyword">:=</span> stackset_back<span class="Cnonalphakeyword">;</span>
  g oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span>
<span class="Cand">and</span> g'_non_tail_if oc dest e1 e2 b bn <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> b_else <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cnonalphakeyword">(</span>b ^ <span class="Cstring">"_else"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Clet">let</span> b_cont <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span>genid <span class="Cnonalphakeyword">(</span>b ^ <span class="Cstring">"_cont"</span><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\t%s\t%s\n"</span> bn b_else<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> stackset_back <span class="Cnonalphakeyword">=</span> !stackset <span class="Cin">in</span>
  g oc <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> e1<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> stackset1 <span class="Cnonalphakeyword">=</span> !stackset <span class="Cin">in</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tb\t%s\n"</span> b_cont<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tnop\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"%s:\n"</span> b_else<span class="Cnonalphakeyword">;</span>
  stackset <span class="Cnonalphakeyword">:=</span> stackset_back<span class="Cnonalphakeyword">;</span>
  g oc <span class="Cnonalphakeyword">(</span>dest<span class="Cnonalphakeyword">,</span> e2<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"%s:\n"</span> b_cont<span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> stackset2 <span class="Cnonalphakeyword">=</span> !stackset <span class="Cin">in</span>
  stackset <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>inter stackset1 stackset2
<span class="Cand">and</span> g'_args oc x_reg_cl ys zs <span class="Cnonalphakeyword">=</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">,</span> yrs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
    <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">,</span> yrs<span class="Cnonalphakeyword">)</span> y <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>i <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> regs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>i<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> yrs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> x_reg_cl<span class="Cnonalphakeyword">)</span>
      ys <span class="Cin">in</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>y<span class="Cnonalphakeyword">,</span> r<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tmov\t%s, %s\n"</span> y r<span class="Cnonalphakeyword">)</span>
    <span class="Cnonalphakeyword">(</span>shuffle reg_sw yrs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Clet">let</span> <span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">,</span> zfrs<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
    <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>fold_left
      <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">,</span> zfrs<span class="Cnonalphakeyword">)</span> z <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">(</span>d <span class="Cnonalphakeyword">+</span> 1<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> fregs<span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span>d<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">::</span> zfrs<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
      <span class="Cnonalphakeyword">(</span>0<span class="Cnonalphakeyword">,</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
      zs <span class="Cin">in</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span>z<span class="Cnonalphakeyword">,</span> fr<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> z fr<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tfmovs\t%s, %s\n"</span> <span class="Cnonalphakeyword">(</span>co_freg z<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span>co_freg fr<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cnonalphakeyword">(</span>shuffle reg_fsw zfrs<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> h oc <span class="Cnonalphakeyword">{</span> name <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> args <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">;</span> fargs <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">_</span><span class="Cnonalphakeyword">;</span> body <span class="Cnonalphakeyword">=</span> e<span class="Cnonalphakeyword">;</span> ret <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">_</span> <span class="Cnonalphakeyword">}</span> <span class="Cnonalphakeyword">=</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"%s:\n"</span> x<span class="Cnonalphakeyword">;</span>
  stackset <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">;</span>
  stackmap <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">;</span>
  g oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Tail</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span>

<span class="Clet">let</span> f oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Prog</span><span class="Cnonalphakeyword">(</span>data<span class="Cnonalphakeyword">,</span> fundefs<span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span>
  <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>eprintf <span class="Cstring">"generating assembly...@."</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">".section\t\".rodata\"\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">".align\t8\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter
    <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Id</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">L</span><span class="Cnonalphakeyword">(</span>x<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> d<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"%s:\t! %f\n"</span> x d<span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\t.long\t0x%lx\n"</span> <span class="Cnonalphakeyword">(</span>gethi d<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\t.long\t0x%lx\n"</span> <span class="Cnonalphakeyword">(</span>getlo d<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    data<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">".section\t\".text\"\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">List</span><span class="Cnonalphakeyword">.</span>iter <span class="Cnonalphakeyword">(</span><span class="Cfun">fun</span> fundef <span class="Cnonalphakeyword">-&gt;</span> h oc fundef<span class="Cnonalphakeyword">)</span> fundefs<span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">".global\tmin_caml_start\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"min_caml_start:\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tsave\t%%sp, -112, %%sp\n"</span><span class="Cnonalphakeyword">;</span> <span class="Ccomment">(* from gcc; why 112? *)</span>
  stackset <span class="Cnonalphakeyword">:=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty<span class="Cnonalphakeyword">;</span>
  stackmap <span class="Cnonalphakeyword">:=</span> <span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">;</span>
  g oc <span class="Cnonalphakeyword">(</span><span class="Cconstructor">NonTail</span><span class="Cnonalphakeyword">(</span><span class="Cstring">"%g0"</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> e<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\tret\n"</span><span class="Cnonalphakeyword">;</span>
  <span class="Cconstructor">Printf</span><span class="Cnonalphakeyword">.</span>fprintf oc <span class="Cstring">"\trestore\n"</span>
</pre>

<hr>
<p>
<em>This document was generated using 
<a href="http://martin.jambon.free.fr/caml2html.html">caml2html</a></em>
</body>
</html>
